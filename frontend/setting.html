<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«é€Ÿè¨­å®šï½œæ™ºè­·ç”Ÿæ´»</title>
  <link rel="icon" href="assets/image/logo.jpg" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/style.css">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  >
  <link rel="stylesheet" href="assets/css/safety-map.css">
</head>
<body>
  <div class="app-shell">
    <header class="top-bar" aria-label="ä¸»è¦å°è¦½">
      <div class="brand">
        <span class="brand-logo" aria-hidden="true">
        <img src="assets/image/logo.jpg" alt="AI Logo" class="logo-img">
        </span>
        <h1>æ™ºè­·ç”Ÿæ´»ï¼šAI ä¼´ä½ </h1>
      </div>
      <button class="menu-toggle" type="button" aria-controls="site-nav" aria-expanded="false" data-menu-toggle>
        <span class="sr-only">åˆ‡æ›å°è¦½é¸å–®</span>
        <span class="hamburger" aria-hidden="true"></span>
      </button>
      <nav id="site-nav" class="nav-links" data-menu>
        <a href="care-dashboard.html" aria-current="page">ç…§è­·ç¸½è¦½</a>
        <a href="setting.html" aria-current="page">é•·è€…è¨­å®š</a>
      </nav>
  <div class="user-menu" id="userMenu" aria-label="ä½¿ç”¨è€…é¸å–®">
        <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false" title="ä½¿ç”¨è€…é¸å–®">
          <span class="sr-only">æ‰“é–‹ä½¿ç”¨è€…é¸å–®</span>
          <span class="avatar-frame">
            <img class="avatar-image" id="avatarImage" alt="ä½¿ç”¨è€…é ­åƒ" hidden>
            <span class="avatar-initials" id="avatarInitials">U</span>
          </span>
        </button>
        <div class="menu-dropdown" id="userDropdown" hidden>
          <div class="user-header">
            <div class="user-name" id="umName">ä½¿ç”¨è€…</div>
            <div class="user-email" id="umEmail"></div>
          </div>
          <a class="menu-item" href="setting.html" id="umAccount">å¸³è™Ÿè¨­å®š</a>
          <button class="menu-item permissions-row" id="permissions-row" type="button">
            <span class="permissions-row-title">æ¬Šé™</span>
          </button>
          <button class="menu-item" id="umLogout" type="button">ç™»å‡º</button>
        </div>
      </div>
    </header>

    <main>
      <section class="hero" aria-label="å¿«é€Ÿè¨­å®šå¼•å°">
        <div>
          <p class="status-pill">3 åˆ†é˜å®Œæˆè¨­å®š</p>
          <h2>æé†’ã€å®‰å…¨ä¸€æ¬¡è¨­å®š</h2>
          <p>ç…§è‘—å•é¡Œå›ç­”ï¼Œå¹¾åˆ†é˜å°±èƒ½å®Œæˆã€‚</p>
        </div>
      </section>

      <!-- è¨­å®šåˆ†é åˆ‡æ›ï¼ˆåƒ…å½±éŸ¿é¡¯ç¤ºï¼Œä¸æ”¹è®Šå„å€å¡ŠåŠŸèƒ½ï¼‰ -->
      <section class="settings-switcher" aria-label="è¨­å®šé …ç›®é¸æ“‡">
        <div class="segment segment--settings" role="tablist">
          <button
            type="button"
            class="segment__item is-active"
            data-settings-panel-target="add-elder"
            role="tab"
            aria-selected="true"
          >
            æ–°å¢å¸³è™Ÿ
          </button>
          <button
            type="button"
            class="segment__item"
            data-settings-panel-target="home-location"
            role="tab"
            aria-selected="false"
          >
            ä½å®¶ä½ç½®è¨­å®š
          </button>
          <button
            type="button"
            class="segment__item"
            data-settings-panel-target="family-share"
            role="tab"
            aria-selected="false"
          >
            å®¶åº­åˆ†äº«èˆ‡ Facebook æˆæ¬Š
          </button>
          <button
            type="button"
            class="segment__item"
            data-settings-panel-target="account"
            role="tab"
            aria-selected="false"
          >
            å¸³è™Ÿå¯†ç¢¼
          </button>
        </div>
      </section>

      <!-- é•·è€…åˆ‡æ›ä¸‹æ‹‰é¸å–®ï¼ˆä¸»è¦çµ¦ç…§è­·è€…ä½¿ç”¨ï¼‰ -->
      <section
        class="settings-elder-switcher"
        id="settings-elder-switcher"
        aria-label="é¸æ“‡æ¬²è¨­å®šçš„é•·è€…"
        hidden
      >
 
      </section>

      <section class="card" id="home-location-card" aria-labelledby="home-location-title" data-settings-panel="home-location">
        <h2 id="home-location-title">ä½å®¶ä½ç½®è¨­å®š</h2>
        <p class="helper-text">è«‹å…ˆé¸æ“‡é•·è€…ï¼Œå†é¸ç¸£å¸‚èˆ‡é„‰é®ï¼Œè¼¸å…¥è·¯åå¾Œæ‹–æ›³ç´…é»åˆ°ä½å®¶é–€å£å³å¯ã€‚</p>
        <div class="map-form">
          <div>
            <label for="homeElderSelect">é¸æ“‡é•·è€…</label>
            <select id="homeElderSelect">
              <option value="">å–å¾—ç¶å®šåˆ—è¡¨ä¸­â€¦</option>
            </select>
            <p class="helper-text" id="homeElderStatus">æ­£åœ¨å–å¾—ç¶å®šçš„é•·è€…æ¸…å–®â€¦</p>
          </div>
          <div>
            <label for="homeCountySelect">ç¸£å¸‚</label>
            <select id="homeCountySelect">
              <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
            </select>
          </div>
          <div>
            <label for="homeDistrictSelect">é„‰é®å¸‚å€</label>
            <select id="homeDistrictSelect" disabled>
              <option value="">è«‹å…ˆé¸æ“‡ç¸£å¸‚</option>
            </select>
          </div>
          <div>
            <label for="homeAddressDetail">è©³ç´°åœ°å€</label>
            <input
              id="homeAddressDetail"
              type="text"
              placeholder="ä¾‹ï¼šæ™¯ç¦è¡— 12 è™Ÿ"
              autocomplete="street-address"
            >
          </div>
          <div class="map-form__actions">
            <button class="btn primary" type="button" id="homeSearchBtn">æŸ¥è©¢ä½ç½®</button>
            <button class="btn primary" type="button" id="homeSaveBtn" disabled>å„²å­˜ä½å®¶åœ°å€</button>
          </div>
        </div>
        <p class="info-text" id="homeStoredInfo"></p>
        <div id="homeFeedback" class="map-feedback" hidden></div>
        <div id="home-map" aria-label="ä½å®¶ä½ç½®é è¦½"></div>
      </section>

      <section class="card" id="family-setup-card" aria-labelledby="family-setup-title" data-settings-panel="family-share">
        <h2 id="family-setup-title">å®¶åº­åˆ†äº«èˆ‡ Facebook æˆæ¬Š</h2>
        <p class="helper-text">é‚€è«‹å®¶äººå®Œæˆæˆæ¬Šå¾Œï¼Œè¦ªå‹è²¼æ–‡èˆ‡èŠå¤©å®¤æ‰èƒ½è®€åˆ°ä»–å€‘çš„è¿‘æ³ã€‚</p>

        <ol class="family-steps">
          <li>
            <strong>1. å®¶äººç™»å…¥ç³»çµ±</strong>
            <p>è«‹å®¶äººä»¥ã€Œå®¶å±¬ã€è§’è‰²ç™»å…¥æ­¤ç³»çµ±ï¼ˆéœ€è¦å¸³è™Ÿå¯†ç¢¼ï¼‰ã€‚</p>
          </li>
          <li>
            <strong>2. é»é¸ã€Œé€£çµ Facebookã€</strong>
            <p>æŒ‰ä¸‹ä¸‹æ–¹æŒ‰éˆ•å¾Œæœƒè·³è‡³ Facebookï¼Œè«‹ç•¶äº‹äººè¦ªè‡ªç¢ºèªæ¬Šé™ã€‚</p>
          </li>
          <li>
            <strong>3. åˆ†äº«æƒ³çµ¦é•·è¼©çœ‹çš„å…§å®¹</strong>
            <p>æˆæ¬Šå®Œæˆå¾Œå³å¯åŒæ­¥è²¼æ–‡ï¼Œæˆ–ä½¿ç”¨ä»¥ä¸‹è¡¨å–®æš«å­˜é€£çµã€‚</p>
          </li>
        </ol>

        <div class="family-actions">
          <div class="family-actions__connect">
            <button class="btn primary" type="button" data-facebook-connect>é€£çµ Facebook</button>
            <p class="helper-text">éœ€ç”±å®¶å±¬å¸³è™Ÿç™»å…¥å¾Œæ“ä½œï¼ŒæŒ‰ä¸‹å¾Œæœƒå°å‘ Facebook ç¢ºèªç•«é¢ã€‚</p>
          </div>
          <div class="family-actions__status">
            <span class="status-pill" id="fbStatusPill">æª¢æŸ¥ä¸­â€¦</span>
            <p class="helper-text" id="fbStatusText">æ­£åœ¨æª¢æŸ¥ Facebook æˆæ¬Šç‹€æ…‹ã€‚</p>
          </div>
        </div>
      </section>

      <section class="card" id="elder-link-card" data-elder-link data-settings-panel="add-elder">
        <h2>é•·è€…å¸³è™Ÿé€£çµ</h2>
        <p class="helper-text">å®¶å±¬èˆ‡ç¤¾å·¥è¼¸å…¥é•·è€… User ID èˆ‡æ‰‹æ©Ÿè™Ÿç¢¼å¾Œï¼Œå³å¯ç¶å®šåˆ°æ­£ç¢ºçš„é•·è€…å¸³è™Ÿï¼ˆæœ€å¤š 3 ä½ï¼‰ã€‚</p>
        <div class="elder-link__status" data-elder-link-status>
          <strong>ç›®å‰ç¶å®šï¼š</strong>
          <span data-elder-link-text>å°šæœªç¶å®š</span>
        </div>
        <form class="elder-link__form" data-elder-link-form>
          <label for="linkElderId">é•·è€… User ID</label>
          <input type="number" id="linkElderId" name="elder_user_id" min="1" required>

          <label for="linkElderPhone">é•·è€…æ‰‹æ©Ÿè™Ÿç¢¼</label>
          <input type="tel" id="linkElderPhone" name="elder_phone" inputmode="numeric" placeholder="09xxxxxxxx" required>

          <button class="btn primary" type="submit">é€å‡ºé€£çµ</button>
        </form>
        <div class="elder-link__self" data-elder-self hidden>
          <p>é€™æ˜¯æ‚¨çš„ User IDï¼š<strong data-current-elder-id>â€”</strong>ï¼Œåˆ†äº«çµ¦å®¶äººå³å¯å®Œæˆç¶å®šã€‚</p>
        </div>
      </section>

    </main>

    <footer>
      <p>Â© 2025 NCCU=MIS+STAT</p>
    </footer>
  </div>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/settings.js"></script>
  <script src="assets/js/elder-link.js"></script>
  <script src="assets/js/toast.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/care-dashboard.js"></script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
  <script type="module">
    import {
      initLeafletMap,
      geocodeAddressViaNominatim,
      saveHome,
      TAIWAN_REGIONS
    } from './assets/js/safety-map.js'

    const STORAGE_KEYS = {
      LAST_HOME_ELDER: 'ai-companion.lastHomeElderId'
    }

    function initHomeLocationCard () {
      if (!window.aiCompanion) return
      const feedbackEl = document.getElementById('homeFeedback')
      const storedInfoEl = document.getElementById('homeStoredInfo')
      const searchBtn = document.getElementById('homeSearchBtn')
      const saveBtn = document.getElementById('homeSaveBtn')
      const countySelect = document.getElementById('homeCountySelect')
      const districtSelect = document.getElementById('homeDistrictSelect')
      const detailInput = document.getElementById('homeAddressDetail')
      const elderSelect = document.getElementById('homeElderSelect')
      const elderStatusEl = document.getElementById('homeElderStatus')
      const globalElderSection = document.getElementById('settings-elder-switcher')
      const globalElderSelect = document.getElementById('settingsElderSelect')
      if (!feedbackEl || !storedInfoEl || !elderSelect || !elderStatusEl) return

      const LAST_ELDER_KEY = STORAGE_KEYS.LAST_HOME_ELDER
      const { map, L } = initLeafletMap('home-map')

      let previewMarker = null
      let latestResult = null
      let resolvedLocation = null
      let isSearching = false
      let lastSearchTs = 0
      let selectedElderId = null
      let elders = []
      let elderLocationRequestId = 0
      const SEARCH_GAP_MS = 1000

      const toNumeric = (value) => {
        const num = Number(value)
        return Number.isFinite(num) ? num : null
      }

      const rememberSelection = (elderId) => {
        try {
          if (Number.isFinite(elderId)) {
            window.localStorage?.setItem(LAST_ELDER_KEY, String(elderId))
          } else {
            window.localStorage?.removeItem(LAST_ELDER_KEY)
          }
        } catch (_) {}
      }

      const readLastSelection = () => {
        try {
          const stored = window.localStorage?.getItem(LAST_ELDER_KEY)
          const num = Number(stored)
          return Number.isFinite(num) ? num : null
        } catch (_) {
          return null
        }
      }

      const getElderDisplayName = (elderIdValue = selectedElderId) => {
        if (!Number.isFinite(elderIdValue)) return 'é•·è€…'
        const match = elders.find((elder) => Number(elder.user_id) === Number(elderIdValue))
        if (!match) return `é•·è€… #${elderIdValue}`
        const label = match.full_name || match.username || `User #${match.user_id}`
        return `${label}ï¼ˆ#${match.user_id}ï¼‰`
      }

      const syncGlobalElderSelect = () => {
        if (!globalElderSelect) return
        globalElderSelect.innerHTML = '<option value="">' + 'è«‹å…ˆæ–°å¢ä¸¦é¸æ“‡é•·è€…' + '</option>'
        if (!elders.length) return
        elders.forEach((elder) => {
          const option = document.createElement('option')
          option.value = elder.user_id
          const label = elder.full_name || elder.username || `User #${elder.user_id}`
          option.textContent = `${label}ï¿½?${elder.user_id}ï¼‰`
          globalElderSelect.appendChild(option)
        })
        if (Number.isFinite(selectedElderId)) {
          globalElderSelect.value = String(selectedElderId)
        } else {
          globalElderSelect.value = ''
        }
      }

      function populateCounties () {
        const counties = Object.keys(TAIWAN_REGIONS).sort((a, b) => a.localeCompare(b))
        for (const county of counties) {
          const option = document.createElement('option')
          option.value = county
          option.textContent = county
          countySelect.appendChild(option)
        }
      }

      function populateDistricts (county, presetValue) {
        districtSelect.innerHTML = ''
        if (!county || !TAIWAN_REGIONS[county]) {
          districtSelect.disabled = true
          districtSelect.setAttribute('disabled', 'disabled')
          const opt = document.createElement('option')
          opt.value = ''
          opt.textContent = 'è«‹å…ˆé¸æ“‡ç¸£å¸‚'
          districtSelect.appendChild(opt)
          return
        }
        const opt = document.createElement('option')
        opt.value = ''
        opt.textContent = 'è«‹é¸æ“‡é„‰é®å¸‚å€'
        districtSelect.appendChild(opt)

        const districts = [...TAIWAN_REGIONS[county]].sort((a, b) => a.localeCompare(b))
        for (const district of districts) {
          const option = document.createElement('option')
          option.value = district
          option.textContent = district
          districtSelect.appendChild(option)
        }
        districtSelect.disabled = false
        districtSelect.removeAttribute('disabled')
        if (presetValue && districts.includes(presetValue)) {
          districtSelect.value = presetValue
        }
      }

      const toggleAddressInputs = (enabled) => {
        const fields = [countySelect, detailInput, searchBtn]
        fields.forEach((field) => {
          if (!field) return
          if (enabled) {
            field.removeAttribute('disabled')
          } else {
            field.setAttribute('disabled', 'disabled')
          }
        })
        if (!enabled) {
          districtSelect.disabled = true
          districtSelect.setAttribute('disabled', 'disabled')
        } else if (countySelect.value && TAIWAN_REGIONS[countySelect.value]) {
          districtSelect.disabled = false
          districtSelect.removeAttribute('disabled')
        }
        saveBtn.disabled = true
      }

      const resetAddressFields = () => {
        countySelect.value = ''
        populateDistricts('')
        detailInput.value = ''
        latestResult = null
        resolvedLocation = null
        saveBtn.disabled = true
        removeMarker()
        clearFeedback()
      }

      populateCounties()
      toggleAddressInputs(false)
      storedInfoEl.textContent = 'è«‹å…ˆé¸æ“‡è¦è¨­å®šçš„é•·è€…ã€‚'

      function showFeedback (message, variant = 'info') {
        feedbackEl.textContent = message
        feedbackEl.hidden = false
        feedbackEl.classList.toggle('map-feedback--error', variant === 'error')
      }

      function clearFeedback () {
        feedbackEl.hidden = true
        feedbackEl.textContent = ''
        feedbackEl.classList.remove('map-feedback--error')
      }

      function onMarkerDragEnd (event) {
        const { lat, lng } = event.target.getLatLng()
        resolvedLocation = { lat, lon: lng }
        saveBtn.disabled = false
        showFeedback('å·²æ›´æ–°å®šä½ï¼Œå¯ç¹¼çºŒæ‹–æ›³æˆ–é»æ“Šåœ°åœ–èª¿æ•´ï¼Œç¢ºèªå¾Œè«‹æŒ‰ã€Œå„²å­˜ä½å®¶åœ°å€ã€ã€‚')
      }

      function onMapClick (event) {
        if (!previewMarker) return
        updateMarkerPosition(event.latlng.lat, event.latlng.lng, { openPopup: false })
        resolvedLocation = { lat: event.latlng.lat, lon: event.latlng.lng }
        saveBtn.disabled = false
        showFeedback('å·²æ›´æ–°å®šä½ï¼Œå¯ç¹¼çºŒæ‹–æ›³æˆ–é»æ“Šåœ°åœ–èª¿æ•´ï¼Œç¢ºèªå¾Œè«‹æŒ‰ã€Œå„²å­˜ä½å®¶åœ°å€ã€ã€‚')
      }

      function updateMarkerPosition (lat, lon, { openPopup = true } = {}) {
        if (previewMarker) {
          previewMarker.off('dragend', onMarkerDragEnd)
          previewMarker.setLatLng([lat, lon])
        } else {
          previewMarker = L.marker([lat, lon], {
            title: 'ä½å®¶ä½ç½®',
            draggable: true,
            icon: L.divIcon({
              className: 'home-marker',
              html: '<span class="home-marker__icon">ğŸ </span>',
              iconAnchor: [16, 32],
              popupAnchor: [0, -28]
            })
          })
            .addTo(map)
            .bindPopup('ä½å®¶ä½ç½®')
        }
        if (openPopup) {
          previewMarker.openPopup()
        }
        previewMarker.on('dragend', onMarkerDragEnd)
        map.off('click', onMapClick)
        map.on('click', onMapClick)
      }

      function removeMarker () {
        if (previewMarker) {
          previewMarker.off('dragend', onMarkerDragEnd)
          map.removeLayer(previewMarker)
          previewMarker = null
        }
        map.off('click', onMapClick)
        resolvedLocation = null
      }

      async function fetchElderLocation (elderId) {
        if (!window.aiCompanion?.fetchJson) return null
        try {
          const res = await window.aiCompanion.fetchJson(`/elder-locations/${elderId}`)
          return res?.location ?? null
        } catch (error) {
          if (typeof error?.message === 'string' && error.message.includes('(404)')) {
            return null
          }
          throw error
        }
      }

      async function hydrateExistingLocation (elderId) {
        elderLocationRequestId += 1
        const requestId = elderLocationRequestId
        const elderLabel = getElderDisplayName(elderId)
        try {
          const location = await fetchElderLocation(elderId)
          if (requestId !== elderLocationRequestId) return
          if (!location) {
            storedInfoEl.textContent = `${elderLabel} å°šæœªå„²å­˜ä½å®¶åœ°å€ï¼Œè«‹å®Œæˆä¸‹æ–¹è¨­å®šã€‚`
            elderStatusEl.textContent = `è«‹å®Œæˆ ${elderLabel} çš„ä½å®¶åœ°å€è¨­å®šã€‚`
            resetAddressFields()
            return
          }
          const storedCounty = location.county || ''
          countySelect.value = storedCounty
          populateDistricts(storedCounty, location.district || '')
          detailInput.value = location.detail || ''
          resolvedLocation = { lat: location.latitude, lon: location.longitude }
          updateMarkerPosition(location.latitude, location.longitude)
          map.setView([location.latitude, location.longitude], 15)
          saveBtn.disabled = true
          storedInfoEl.textContent = `${elderLabel} ç›®å‰å„²å­˜åœ°å€ï¼š${location.address}`
          elderStatusEl.textContent = `å¦‚éœ€æ›´æ–° ${elderLabel} çš„ä½å®¶åœ°å€ï¼Œå¯é‡æ–°æŸ¥è©¢å¾Œå„²å­˜ã€‚`
        } catch (error) {
          if (requestId !== elderLocationRequestId) return
          console.error('Load elder location failed', error)
          storedInfoEl.textContent = `${elderLabel} çš„ä½å®¶è³‡æ–™è¼‰å…¥å¤±æ•—ã€‚`
          showFeedback('ç„¡æ³•å–å¾—å„²å­˜çš„ä½å®¶åœ°å€ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error')
        }
      }

      async function handleElderChange () {
        resetAddressFields()
        const selectedValue = toNumeric(elderSelect.value)
        if (!selectedValue) {
          selectedElderId = null
          rememberSelection(null)
          storedInfoEl.textContent = 'è«‹å…ˆé¸æ“‡è¦è¨­å®šçš„é•·è€…ã€‚'
          elderStatusEl.textContent = 'è«‹åœ¨ä¸‹æ–¹ç¶å®šé•·è€…ï¼Œæˆ–å¾æ¸…å–®ä¸­é¸æ“‡ã€‚'
          toggleAddressInputs(false)
          return
        }
        selectedElderId = selectedValue
        rememberSelection(selectedValue)
        toggleAddressInputs(true)
        storedInfoEl.textContent = `æ­£åœ¨è¼‰å…¥ ${getElderDisplayName()} çš„ä½å®¶åœ°å€â€¦`
        await hydrateExistingLocation(selectedValue)
      }

      async function loadLinkedElders () {
        if (!window.aiCompanion?.fetchJson) {
          elderStatusEl.textContent = 'ç³»çµ±å°šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'
          toggleAddressInputs(false)
          return
        }
        elderSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­â€¦</option>'
        elderStatusEl.textContent = 'æ­£åœ¨å–å¾—ç¶å®šçš„é•·è€…â€¦'
        try {
          const res = await window.aiCompanion.fetchJson('/users/linked-elder')
          elders = Array.isArray(res?.elders) ? res.elders : []
          if (!elders.length) {
            elderSelect.innerHTML = '<option value="">å°šæœªç¶å®šé•·è€…</option>'
            elderStatusEl.textContent = 'å°šæœªç¶å®šé•·è€…ï¼Œè«‹å…ˆåœ¨ä¸‹æ–¹å®Œæˆã€Œé•·è€…å¸³è™Ÿé€£çµã€ã€‚'
            toggleAddressInputs(false)
            storedInfoEl.textContent = 'ç¶å®šé•·è€…å¾Œå³å¯è¨­å®šä½å®¶åœ°å€ã€‚'
            return
          }
          elderSelect.innerHTML = '<option value="">è«‹é¸æ“‡é•·è€…</option>'
          elders.forEach((elder) => {
            const option = document.createElement('option')
            option.value = elder.user_id
            const label = elder.full_name || elder.username || `User #${elder.user_id}`
            option.textContent = `${label}ï¼ˆ#${elder.user_id}ï¼‰`
            elderSelect.appendChild(option)
          })
          const lastSelection = readLastSelection()
          if (lastSelection && elders.some((elder) => Number(elder.user_id) === lastSelection)) {
            elderSelect.value = String(lastSelection)
            await handleElderChange()
          } else {
            storedInfoEl.textContent = 'è«‹å…ˆé¸æ“‡è¦è¨­å®šçš„é•·è€…ã€‚'
            toggleAddressInputs(false)
          }
          elderStatusEl.textContent = 'è«‹é¸æ“‡è¦è¨­å®šä½å€çš„é•·è€…ã€‚'
        } catch (error) {
          console.error('Load elder list failed', error)
          elderSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>'
          elderStatusEl.textContent = 'ç„¡æ³•å–å¾—é•·è€…æ¸…å–®ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'
          toggleAddressInputs(false)
        }
      }

      async function handleSearch () {
        if (!selectedElderId) {
          showFeedback('è«‹å…ˆé¸æ“‡è¦è¨­å®šçš„é•·è€…ã€‚', 'error')
          return
        }
        if (isSearching) return

        const now = Date.now()
        if (now - lastSearchTs < SEARCH_GAP_MS) {
          showFeedback('è«‹ç¨å€™å†æŸ¥è©¢ã€‚')
          return
        }

        const county = countySelect.value.trim()
        const district = districtSelect.value.trim()
        const detail = detailInput.value.trim()

        if (!county) {
          showFeedback('è«‹å…ˆé¸æ“‡ç¸£å¸‚ã€‚', 'error')
          return
        }
        if (!district) {
          showFeedback('è«‹å…ˆé¸æ“‡é„‰é®å¸‚å€ã€‚', 'error')
          return
        }
        if (!detail) {
          showFeedback('è«‹è£œå……ä½å®¶è©³ç´°åœ°å€ã€‚', 'error')
          return
        }

        isSearching = true
        lastSearchTs = now
        saveBtn.disabled = true
        showFeedback('æ­£åœ¨æŸ¥è©¢ä½ç½®â€¦')

        try {
          const result = await geocodeAddressViaNominatim({ county, district, detail })
          if (!result) {
            latestResult = null
            resolvedLocation = null
            showFeedback('æ‰¾ä¸åˆ°æ­¤åœ°å€ï¼Œè«‹ç¢ºèªå¾Œå†è©¦ã€‚', 'error')
            removeMarker()
            return
          }

          latestResult = result
          resolvedLocation = { lat: result.lat, lon: result.lon }
          clearFeedback()
          showFeedback(`å·²æ‰¾åˆ°ï¼š${result.displayName}
è«‹ç¢ºèªåœ°åœ–ä½ç½®ï¼Œå¯æ‹–æ›³æˆ–é»æ“Šåœ°åœ–å¾®èª¿å¾Œå†å„²å­˜ã€‚`)
          updateMarkerPosition(result.lat, result.lon)
          map.setView([result.lat, result.lon], 16)
          saveBtn.disabled = false
          saveBtn.focus()
        } catch (error) {
          console.error('Home geocode failed', error)
          latestResult = null
          resolvedLocation = null
          showFeedback('æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error')
          removeMarker()
        } finally {
          isSearching = false
        }
      }

      async function handleSave () {
        if (!selectedElderId) {
          showFeedback('è«‹å…ˆé¸æ“‡è¦è¨­å®šçš„é•·è€…ã€‚', 'error')
          return
        }
        const county = countySelect.value.trim()
        const district = districtSelect.value.trim()
        const detail = detailInput.value.trim()

        if (!county || !district || !detail) {
          showFeedback('è«‹å…ˆå®Œæˆåœ°å€é¸æ“‡èˆ‡æŸ¥è©¢ã€‚', 'error')
          return
        }

        const coords = resolvedLocation ?? (latestResult
          ? { lat: latestResult.lat, lon: latestResult.lon }
          : null)
        if (!coords) {
          showFeedback('è«‹å…ˆåœ¨åœ°åœ–ä¸Šç¢ºèªä½å®¶ä½ç½®ã€‚', 'error')
          return
        }

        if (!window.aiCompanion?.fetchJson) {
          showFeedback('ç³»çµ±å°šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error')
          return
        }

        try {
          const formattedAddress = `${county}${district}${detail}`
          await window.aiCompanion.fetchJson(`/elder-locations/${selectedElderId}`, {
            method: 'PUT',
            body: JSON.stringify({
              address: formattedAddress,
              lat: coords.lat,
              lon: coords.lon,
              county,
              district,
              detail
            })
          })
          saveHome({
            address: formattedAddress,
            lat: coords.lat,
            lon: coords.lon
          })
          storedInfoEl.textContent = `${getElderDisplayName()} ç›®å‰å„²å­˜åœ°å€ï¼š${formattedAddress}`
          showFeedback('å·²å„²å­˜ä½å®¶åœ°å€ã€‚')
          saveBtn.disabled = true
          if (window.showToast) {
            window.showToast('å·²å„²å­˜ä½å®¶åœ°å€ã€‚', { variant: 'success' })
          }
        } catch (error) {
          console.error('Save elder location failed', error)
          showFeedback('å„²å­˜ä½å®¶åœ°å€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error')
        }
      }

      elderSelect?.addEventListener('change', () => {
        handleElderChange()
      })

      countySelect.addEventListener('change', () => {
        if (!selectedElderId) return
        populateDistricts(countySelect.value)
        districtSelect.value = ''
        detailInput.value = ''
        saveBtn.disabled = true
        latestResult = null
        resolvedLocation = null
        removeMarker()
        clearFeedback()
      })

      districtSelect.addEventListener('change', () => {
        if (!selectedElderId) return
        detailInput.value = ''
        saveBtn.disabled = true
        latestResult = null
        resolvedLocation = null
        removeMarker()
        clearFeedback()
      })

      detailInput.addEventListener('input', () => {
        if (!selectedElderId) return
        saveBtn.disabled = true
        latestResult = null
        resolvedLocation = null
        removeMarker()
        clearFeedback()
      })
      searchBtn.addEventListener('click', () => {
        handleSearch()
      })
      saveBtn.addEventListener('click', () => {
        handleSave()
      })

      loadLinkedElders()
    }

    function hideHomeLocationCard () {
      const card = document.getElementById('home-location-card')
      if (card) {
        card.hidden = true
        card.setAttribute('aria-hidden', 'true')
      }
    }

    const activeRole = window.aiCompanion?.getActiveRole?.() || ''
    const normalizedRole = window.aiCompanion?.normalizeRole?.(activeRole) || activeRole || ''
    const elderRoles = ['elder', 'senior', 'grandpa', 'grandma']
    const isElderRole = elderRoles.includes(normalizedRole.toLowerCase())

    if (isElderRole) {
      hideHomeLocationCard()
    } else {
      initHomeLocationCard()
    }

    function initFamilyCard () {
      const card = document.getElementById('family-setup-card')
      if (!card) return

      const statusPill = document.getElementById('fbStatusPill')
      const statusText = document.getElementById('fbStatusText')

      async function checkFacebookStatus () {
        if (!window.aiCompanion?.fetchJson || !statusPill || !statusText) return
        try {
          const data = await window.aiCompanion.fetchJson('/facebook/posts?limit=1')
          if (data?.disabled) {
            statusPill.textContent = 'å°šæœªæˆæ¬Š'
            statusPill.classList.remove('status-pill--ok')
            statusPill.classList.add('status-pill--warn')
            statusText.textContent = 'å°šæœªé‚€è«‹ä»»ä½•å®¶äººæˆæ¬Šï¼Œè«‹å…ˆé€å‡ºé‚€è«‹ã€‚'
          } else {
            statusPill.textContent = 'æˆæ¬Šæ­£å¸¸'
            statusPill.classList.remove('status-pill--warn')
            statusPill.classList.add('status-pill--ok')
            statusText.textContent = 'å·²åµæ¸¬åˆ°å®¶äººæˆæ¬Šï¼Œæœƒè‡ªå‹•åŒæ­¥è²¼æ–‡ã€‚'
          }
        } catch (error) {
          statusPill.textContent = 'æª¢æŸ¥å¤±æ•—'
          statusPill.classList.remove('status-pill--ok')
          statusPill.classList.add('status-pill--warn')
          statusText.textContent = 'ç„¡æ³•æª¢æŸ¥æˆæ¬Šç‹€æ…‹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'
          console.warn('[settings] fetch facebook status failed', error)
        }
      }

      checkFacebookStatus()
    }

    document.addEventListener('DOMContentLoaded', () => {
      initFamilyCard()
    })

    document.addEventListener('DOMContentLoaded', () => {
      const connectBtn = document.querySelector('[data-facebook-connect]')
      if (connectBtn) {
        connectBtn.addEventListener('click', async () => {
          if (!window.aiCompanion?.fetchJson) return
          connectBtn.disabled = true
          connectBtn.textContent = 'å‰å¾€ Facebook ä¸­â€¦'
          try {
            const data = await window.aiCompanion.fetchJson('/facebook/auth/url')
            if (data?.url) {
              window.location.href = data.url
            } else {
              throw new Error('missing_url')
            }
          } catch (error) {
            console.warn('[settings] ç„¡æ³•å–å¾— Facebook OAuth URL', error)
            alert('ç„¡æ³•å•Ÿå‹• Facebook æˆæ¬Šï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚')
            connectBtn.disabled = false
            connectBtn.textContent = 'é€£çµ Facebook'
          }
        })
      }

      const params = new URLSearchParams(window.location.search)
      const fbStatus = params.get('facebook') || params.get('status')
      if (fbStatus === 'success' && window.showToast) {
        window.showToast('Facebook æˆæ¬ŠæˆåŠŸï¼Œç¨å¾Œå°‡è‡ªå‹•åŒæ­¥è²¼æ–‡ã€‚', { variant: 'success' })
        params.delete('facebook')
        params.delete('status')
        params.delete('message')
        const newUrl = `${window.location.pathname}${params.toString() ? `?${params.toString()}` : ''}${window.location.hash}`
        window.history.replaceState({}, '', newUrl)
      } else if (fbStatus && fbStatus !== 'success' && window.showToast) {
        window.showToast('Facebook æˆæ¬Šå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚', { variant: 'error' })
        params.delete('facebook')
        params.delete('status')
        params.delete('message')
        const newUrl = `${window.location.pathname}${params.toString() ? `?${params.toString()}` : ''}${window.location.hash}`
        window.history.replaceState({}, '', newUrl)
      }
    })
  </script>
  <script>
    (function initAccountSettings(){
      const API_BASE = (window.aiCompanion?.getApiBase?.() || 'http://localhost:3001').replace(/\/$/, '')
      const ELDER_MATCH = ['elder', 'senior', 'grandpa', 'grandma']

      const resolveActiveRole = () => {
        const raw = window.aiCompanion?.getActiveRole?.() || ''
        const normalized = window.aiCompanion?.normalizeRole?.(raw) || raw || ''
        return normalized.toLowerCase()
      }

      const isElderLocked = () => ELDER_MATCH.includes(resolveActiveRole())

      function insertElderNotice () {
        const existing = document.getElementById('elder-lock-card')
        if (existing) return existing
        const main = document.querySelector('main')
        if (!main) return null
        const notice = document.createElement('section')
        notice.className = 'card'
        notice.id = 'elder-lock-card'
        notice.dataset.settingsPanel = 'home-location'
        notice.innerHTML = `
          <h2>ç”±å®¶å±¬å”åŠ©ç®¡ç†</h2>
          <p class="helper-text">æ­¤é é¢çš„ä½å®¶ä½ç½®èˆ‡å¸³è™Ÿè³‡è¨Šåƒ…ä¾›å®¶å±¬æˆ–ç…§è­·è€…èª¿æ•´ã€‚å¦‚éœ€æ›´æ–°ï¼Œè«‹èˆ‡å®¶å±¬è¯ç¹«ã€‚</p>
        `
        const anchor = document.getElementById('family-setup-card')?.closest('section')
        if (anchor) {
          main.insertBefore(notice, anchor)
        } else {
          main.appendChild(notice)
        }
        return notice
      }

      async function fetchMe() {
        try {
          const res = await fetch(`${API_BASE}/api/users/me`, { credentials: 'include' })
          if (!res.ok) {
            location.href = 'login.html?error=login_required'
            return null
          }
          const { user } = await res.json()
          return user
        } catch {
          location.href = 'login.html?error=login_required'
          return null
        }
      }

      function ensureForms() {
        // Account profile form (create if missing)
        let profileCard = document.getElementById('account-card')
        if (!profileCard) {
          const main = document.querySelector('main') || document.body
          profileCard = document.createElement('section')
          profileCard.className = 'card'
          profileCard.id = 'account-card'
          profileCard.dataset.settingsPanel = 'account'
          profileCard.innerHTML = `
            <h2>å¸³è™Ÿè³‡è¨Š</h2>
            <form id="profileForm">
              <div><label>å§“å</label><input id="full_name" name="full_name" type="text"></div>
              <div><label>é›»å­éƒµä»¶</label><input id="email" name="email" type="email"></div>
              <div><label>ä½¿ç”¨è€…åç¨±</label><input id="username" name="username" type="text"></div>
              <div><label>å¹´é½¡</label><input id="age" name="age" type="number" min="0"></div>
              <div><label>é›»è©±</label><input id="phone" name="phone" type="tel"></div>
              <div><label>åœ°å€</label><input id="address" name="address" type="text"></div>
              <button class="btn primary" type="submit">å„²å­˜</button>
            </form>`
          main.appendChild(profileCard)
        }

        let pwCard = document.getElementById('password-card')
        if (!pwCard) {
          const main = document.querySelector('main') || document.body
          pwCard = document.createElement('section')
          pwCard.className = 'card'
          pwCard.id = 'password-card'
          pwCard.dataset.settingsPanel = 'account'
          pwCard.innerHTML = `
            <h2>è®Šæ›´å¯†ç¢¼</h2>
            <form id="passwordForm">
              <div><label>ç›®å‰å¯†ç¢¼</label><input id="currentPassword" name="currentPassword" type="password" required></div>
              <div><label>æ–°å¯†ç¢¼</label><input id="newPassword" name="newPassword" type="password" required></div>
              <div><label>ç¢ºèªæ–°å¯†ç¢¼</label><input id="confirmNewPassword" name="confirmNewPassword" type="password" required></div>
              <button class="btn primary" type="submit">æ›´æ–°å¯†ç¢¼</button>
            </form>`
          main.appendChild(pwCard)
        }
      }

      async function bootstrap() {
        const locked = isElderLocked()
        if (locked) {
          insertElderNotice()
          const homeCard = document.getElementById('home-location-card')
          if (homeCard) {
            homeCard.hidden = true
            homeCard.setAttribute('aria-hidden', 'true')
          }
        } else {
          ensureForms()
        }
        const user = await fetchMe()
        if (!user || locked) return
        // Fill profile fields
        const byId = (id) => document.getElementById(id)
        if (byId('full_name')) byId('full_name').value = user.full_name || ''
        if (byId('email')) byId('email').value = user.email || ''
        if (byId('username')) byId('username').value = user.username || ''
        if (byId('age')) byId('age').value = user.age ?? ''
        if (byId('phone')) byId('phone').value = user.phone || ''
        if (byId('address')) byId('address').value = user.address || ''

        // Bind submit events
        const profileForm = document.getElementById('profileForm')
        if (profileForm) profileForm.addEventListener('submit', async (e) => {
          e.preventDefault()
          const payload = Object.fromEntries(new FormData(profileForm).entries())
          // Clean empty strings to undefined so PATCH can detect
          Object.keys(payload).forEach(k => { if (payload[k] === '') delete payload[k] })
          try {
            const res = await fetch(`${API_BASE}/api/users/me`, {
              method: 'PATCH', headers: { 'Content-Type': 'application/json' },
              credentials: 'include', body: JSON.stringify(payload)
            })
            if (res.ok) { if (window.showToast) showToast('å·²æ›´æ–°', { variant: 'success' }); location.reload() }
            else {
              const err = await res.json().catch(()=>({}))
              const msg = err.error === 'email_taken' ? 'Email å·²è¢«ä½¿ç”¨' : err.error === 'username_taken' ? 'ä½¿ç”¨è€…åç¨±å·²è¢«ä½¿ç”¨' : 'æ›´æ–°å¤±æ•—'
              if (window.showToast) showToast(msg, { variant: 'error' }); else alert(msg)
            }
          } catch { alert('æ›´æ–°å¤±æ•—') }
        })

        const passwordForm = document.getElementById('passwordForm')
        if (passwordForm) passwordForm.addEventListener('submit', async (e) => {
          e.preventDefault()
          const currentPassword = document.getElementById('currentPassword').value
          const newPassword = document.getElementById('newPassword').value
          const confirm = document.getElementById('confirmNewPassword').value
          if (!newPassword || newPassword.length < 8) { alert('æ–°å¯†ç¢¼è‡³å°‘ 8 ç¢¼'); return }
          if (newPassword !== confirm) { alert('æ–°å¯†ç¢¼èˆ‡ç¢ºèªä¸ä¸€è‡´'); return }
          try {
            const res = await fetch(`${API_BASE}/api/auth/change-password`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              credentials: 'include', body: JSON.stringify({ currentPassword, newPassword })
            })
            if (res.ok) { if (window.showToast) showToast('å·²æ›´æ–°å¯†ç¢¼ï¼Œè«‹é‡æ–°ç™»å…¥', { variant: 'success' }); location.href = 'login.html?error=login_required' }
            else {
              const err = await res.json().catch(()=>({}))
              const msg = err.error === 'wrong_password' ? 'ç›®å‰å¯†ç¢¼ä¸æ­£ç¢º' : 'æ›´æ–°å¤±æ•—'
              if (window.showToast) showToast(msg, { variant: 'error' }); else alert(msg)
            }
          } catch { alert('æ›´æ–°å¤±æ•—') }
        })
      }

      document.addEventListener('DOMContentLoaded', bootstrap)
    })()
  </script>
  <script>
    (function initSettingsPanelsAndElderSwitcher () {
      const CARE_ROLES = ['family', 'caregiver', 'social_worker', 'worker', 'case_manager']

      const resolveRole = () => {
        const raw = window.aiCompanion?.getActiveRole?.() || ''
        const normalized = window.aiCompanion?.normalizeRole?.(raw) || raw || ''
        return normalized.toLowerCase()
      }

      // ç›®å‰æ‰€æœ‰è§’è‰²å…±ç”¨åŒä¸€å¥—è¨­å®šåˆ†é é¡¯ç¤ºé‚è¼¯
      const isCareRole = () => true

      function setupPanels () {
        const buttons = Array.from(document.querySelectorAll('[data-settings-panel-target]'))
        if (!buttons.length) return

        const homeCard = document.getElementById('home-location-card')
        const familyCard = document.getElementById('family-setup-card')
        const elderCard = document.getElementById('elder-link-card')
        const getAccountPanels = () => [
          document.getElementById('account-card'),
          document.getElementById('password-card')
        ].filter(Boolean)

        const PANEL_MAP = {
          'add-elder': () => [elderCard],
          'home-location': () => [homeCard],
          'family-share': () => [familyCard],
          account: () => getAccountPanels()
        }

        const showPanel = (key) => {
          const getter = PANEL_MAP[key] || PANEL_MAP['add-elder']
          const activePanels = getter().filter(Boolean)
          const allPanels = [
            homeCard,
            familyCard,
            elderCard,
            ...getAccountPanels(),
            document.getElementById('elder-lock-card')
          ].filter(Boolean)

          // è‹¥ä¸æ˜¯ç…§è­·è€…è§’è‰²ï¼Œä¸å¼·è¡Œéš±è—å…¶ä»–å¡ç‰‡
          if (!isCareRole()) {
            allPanels.forEach((el) => {
              el.hidden = false
              el.removeAttribute('aria-hidden')
            })
            return
          }

          allPanels.forEach((el) => {
            const visible = activePanels.includes(el)
            el.hidden = !visible
            el.setAttribute('aria-hidden', visible ? 'false' : 'true')
          })
        }

        buttons.forEach((btn) => {
          btn.addEventListener('click', () => {
            const target = btn.getAttribute('data-settings-panel-target')
            buttons.forEach((b) => {
              const active = b === btn
              b.classList.toggle('is-active', active)
              b.setAttribute('aria-selected', active ? 'true' : 'false')
            })
            showPanel(target)
          })
        })

        // é è¨­é¡¯ç¤ºã€Œæ–°å¢å¸³è™Ÿã€å€å¡Šï¼ˆç…§è­·è€…ï¼‰ï¼›é•·è€…å‰‡ç¶­æŒåŸæœ¬æ’åˆ—
        if (isCareRole()) {
          showPanel('add-elder')
        }
      }

      function setupElderSwitcher () {
        const globalSelect = document.getElementById('settingsElderSelect')
        const globalSection = document.getElementById('settings-elder-switcher')
        const homeSelect = document.getElementById('homeElderSelect')
        if (!globalSelect || !globalSection || !homeSelect) return
        if (!isCareRole()) return

        const syncFromHome = () => {
          const options = Array.from(homeSelect.options)
          if (!options.length) return
          globalSelect.innerHTML = ''
          options.forEach((opt) => {
            const clone = opt.cloneNode(true)
            globalSelect.appendChild(clone)
          })
          globalSection.hidden = false
          globalSelect.value = homeSelect.value || ''
        }

        // åˆå§‹åŒæ­¥ï¼ˆç­‰å¾… homeSelect ç”±åŸæœ¬ç¨‹å¼è¼‰å…¥å®Œæˆï¼‰
        setTimeout(syncFromHome, 0)

        homeSelect.addEventListener('change', () => {
          syncFromHome()
        })
        try {
          const observer = new MutationObserver(() => {
            syncFromHome()
          })
          observer.observe(homeSelect, { childList: true })
        } catch (_) {}

        globalSelect.addEventListener('change', () => {
          if (homeSelect.value === globalSelect.value) return
          homeSelect.value = globalSelect.value
          const ev = new Event('change', { bubbles: true })
          homeSelect.dispatchEvent(ev)
        })
      }

                  document.addEventListener('DOMContentLoaded', () => {
        if (!window.aiCompanion) return
        // åˆ†é é¡¯ç¤ºäº¤çµ¦ simpleSettingsPanelSwitcherï¼Œé€™è£¡åªè™•ç†é•·è€…ä¸‹æ‹‰åŒæ­¥
        setupElderSwitcher()
      })
    })()
  </script>


      <script>
    // è¨­å®šåˆ†é åˆ‡æ›ï¼šä¾åœ“è§’æŒ‰éˆ•é¡¯ç¤ºå°æ‡‰å¡ç‰‡
    (function simpleSettingsPanelSwitcher () {
      const TAB_STORAGE_KEY = 'ai-companion-settings-tab';

      const init = () => {
        const buttons = Array.from(document.querySelectorAll('[data-settings-panel-target]'));
        if (!buttons.length) return;

        const refreshPanels = () => Array.from(document.querySelectorAll('[data-settings-panel]'));
        let panels = refreshPanels();

        const showPanel = (key, { skipPersist = false } = {}) => {
          panels = refreshPanels();
          panels.forEach((el) => {
            const match = (el.dataset.settingsPanel || '').split(',').map(s => s.trim());
            const visible = match.includes(key);
            el.hidden = !visible;
            el.setAttribute('aria-hidden', visible ? 'false' : 'true');
          });
          if (!skipPersist) {
            try {
              sessionStorage.setItem(TAB_STORAGE_KEY, key);
            } catch (_) {}
          }
        };

        buttons.forEach((btn) => {
          btn.addEventListener('click', () => {
            const key = btn.getAttribute('data-settings-panel-target');
            buttons.forEach((b) => {
              const active = b === btn;
              b.classList.toggle('is-active', active);
              b.setAttribute('aria-selected', active ? 'true' : 'false');
            });
            showPanel(key);
          });
        });

        const storedKey = (() => {
          try {
            return sessionStorage.getItem(TAB_STORAGE_KEY) || '';
          } catch (_) {
            return '';
          }
        })();
        const availableKeys = new Set(
          panels.flatMap(p => (p.dataset.settingsPanel || '').split(',').map(s => s.trim()).filter(Boolean))
        );
        const initialKey = storedKey && availableKeys.has(storedKey) ? storedKey : 'add-elder';

        const initialBtn = buttons.find((btn) => btn.getAttribute('data-settings-panel-target') === initialKey);
        if (initialBtn) {
          buttons.forEach((b) => {
            const active = b === initialBtn;
            b.classList.toggle('is-active', active);
            b.setAttribute('aria-selected', active ? 'true' : 'false');
          });
        }
        showPanel(initialKey, { skipPersist: true });

        // è‹¥å¸³è™Ÿå¡ç‰‡ç¨å¾Œæ‰æ’å…¥ DOMï¼Œè§€å¯Ÿ main ä¸¦é‡æ–°å¥—ç”¨ä¸€æ¬¡ç›®å‰åˆ†é éš±è—ç‹€æ…‹ã€‚
        try {
          const main = document.querySelector('main');
          if (main) {
            const observer = new MutationObserver(() => {
              panels = refreshPanels();
              const activeBtn = buttons.find((btn) => btn.classList.contains('is-active'));
              const key = activeBtn?.getAttribute('data-settings-panel-target') || initialKey;
              showPanel(key, { skipPersist: true });
            });
            observer.observe(main, { childList: true });
          }
        } catch (_) {}
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
