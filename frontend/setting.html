<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«é€Ÿè¨­å®šï½œæ™ºè­·ç”Ÿæ´»</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  >
  <link rel="stylesheet" href="assets/css/safety-map.css">
</head>
<body>
  <div class="app-shell">
    <header class="top-bar" aria-label="ä¸»è¦å°è¦½">
      <div class="brand">
        <span class="brand-logo" aria-hidden="true">
        <img src="assets/image/logo.jpg" alt="AI Logo" class="logo-img">
        </span>
        <h1>æ™ºè­·ç”Ÿæ´»ï¼šAI ä¼´ä½ </h1>
      </div>
      <button class="menu-toggle" type="button" aria-controls="site-nav" aria-expanded="false" data-menu-toggle>
        <span class="sr-only">åˆ‡æ›å°è¦½é¸å–®</span>
        <span class="hamburger" aria-hidden="true"></span>
      </button>
      <nav id="site-nav" class="nav-links" data-menu>
        <a href="index.html">é¦–é </a>
        <a href="selection.html">é™ªä¼´è¨­å®š</a>
        <a href="setting.html" aria-current="page">å¿«é€Ÿè¨­å®š</a>
        <a href="ranking.html">å¥åº·æ’è¡Œæ¦œ</a>
        <a href="forum.html">ç¤¾ç¾¤å…¬åœ’</a>
        <a href="guide.html">é›¢ç·šå¹«åŠ©æŒ‡å—</a>
      </nav>
    </header>

    <main>
      <section class="hero" aria-label="å¿«é€Ÿè¨­å®šå¼•å°">
        <div>
          <p class="status-pill">3 åˆ†é˜å®Œæˆè¨­å®š</p>
          <h2>èªéŸ³ã€æé†’ã€å®‰å…¨ä¸€æ¬¡è¨­å®š</h2>
          <p>ç…§è‘—å•é¡Œå›ç­”ï¼Œå¹¾åˆ†é˜å°±èƒ½å®Œæˆã€‚</p>
        </div>
      </section>

      <section class="card" id="home-location-card" aria-labelledby="home-location-title">
        <h2 id="home-location-title">ä½å®¶ä½ç½®è¨­å®š</h2>
        <p class="helper-text">å…ˆé¸ç¸£å¸‚èˆ‡é„‰é®ï¼Œå†è¼¸å…¥è·¯åï¼Œæ‹–æ›³ç´…é»åˆ°ä½å®¶é–€å£å³å¯ã€‚</p>
        <div class="map-form">
          <div>
            <label for="homeCountySelect">ç¸£å¸‚</label>
            <select id="homeCountySelect">
              <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
            </select>
          </div>
          <div>
            <label for="homeDistrictSelect">é„‰é®å¸‚å€</label>
            <select id="homeDistrictSelect" disabled>
              <option value="">è«‹å…ˆé¸æ“‡ç¸£å¸‚</option>
            </select>
          </div>
          <div>
            <label for="homeAddressDetail">è©³ç´°åœ°å€</label>
            <input
              id="homeAddressDetail"
              type="text"
              placeholder="ä¾‹ï¼šæ™¯ç¦è¡— 12 è™Ÿ"
              autocomplete="street-address"
            >
          </div>
          <div class="map-form__actions">
            <button class="btn primary" type="button" id="homeSearchBtn">æŸ¥è©¢ä½ç½®</button>
            <button class="btn primary" type="button" id="homeSaveBtn" disabled>å„²å­˜ä½å®¶åœ°å€</button>
          </div>
        </div>
        <p class="info-text" id="homeStoredInfo"></p>
        <div id="homeFeedback" class="map-feedback" hidden></div>
        <div id="home-map" aria-label="ä½å®¶ä½ç½®é è¦½"></div>
      </section>

      <section class="card" id="family-setup-card" aria-labelledby="family-setup-title">
        <h2 id="family-setup-title">å®¶åº­åˆ†äº«èˆ‡ Facebook æˆæ¬Š</h2>
        <p class="helper-text">é‚€è«‹å®¶äººå®Œæˆæˆæ¬Šå¾Œï¼Œè¦ªå‹è²¼æ–‡èˆ‡èŠå¤©å®¤æ‰èƒ½è®€åˆ°ä»–å€‘çš„è¿‘æ³ã€‚</p>

        <ol class="family-steps">
          <li>
            <strong>1. å®¶äººç™»å…¥ç³»çµ±</strong>
            <p>è«‹å®¶äººä»¥ã€Œå®¶å±¬ã€è§’è‰²ç™»å…¥æ­¤ç³»çµ±ï¼ˆéœ€è¦å¸³è™Ÿå¯†ç¢¼ï¼‰ã€‚</p>
          </li>
          <li>
            <strong>2. é»é¸ã€Œé€£çµ Facebookã€</strong>
            <p>æŒ‰ä¸‹ä¸‹æ–¹æŒ‰éˆ•å¾Œæœƒè·³è‡³ Facebookï¼Œè«‹ç•¶äº‹äººè¦ªè‡ªç¢ºèªæ¬Šé™ã€‚</p>
          </li>
          <li>
            <strong>3. åˆ†äº«æƒ³çµ¦é•·è¼©çœ‹çš„å…§å®¹</strong>
            <p>æˆæ¬Šå®Œæˆå¾Œå³å¯åŒæ­¥è²¼æ–‡ï¼Œæˆ–ä½¿ç”¨ä»¥ä¸‹è¡¨å–®æš«å­˜é€£çµã€‚</p>
          </li>
        </ol>

        <div class="family-actions">
          <div class="family-actions__connect">
            <button class="btn primary" type="button" data-facebook-connect>é€£çµ Facebook</button>
            <p class="helper-text">éœ€ç”±å®¶å±¬å¸³è™Ÿç™»å…¥å¾Œæ“ä½œï¼ŒæŒ‰ä¸‹å¾Œæœƒå°å‘ Facebook ç¢ºèªç•«é¢ã€‚</p>
          </div>
          <div class="family-actions__status">
            <span class="status-pill" id="fbStatusPill">æª¢æŸ¥ä¸­â€¦</span>
            <p class="helper-text" id="fbStatusText">æ­£åœ¨æª¢æŸ¥ Facebook æˆæ¬Šç‹€æ…‹ã€‚</p>
          </div>
        </div>

        <div class="family-share">
          <h3>æ‰‹å‹•åˆ†äº«é€£çµï¼ˆæš«å­˜ï¼‰</h3>
          <p class="helper-text">æ­¤åŠŸèƒ½å…ˆæš«å­˜åœ¨æœ¬æ©Ÿï¼Œä¹‹å¾Œå¯åŒæ­¥åˆ°å¾Œç«¯ `family_feed_shares`ã€‚</p>
          <form id="familyShareForm">
            <label for="shareName">åˆ†äº«äººå§“å</label>
            <input type="text" id="shareName" placeholder="ä¾‹å¦‚ï¼šä½©çœŸé˜¿å§¨" required>

            <label for="shareSummary">æƒ³åˆ†äº«çš„è©±</label>
            <textarea id="shareSummary" rows="2" maxlength="120" placeholder="ç°¡è¿°å…§å®¹ï¼Œ120 å­—å…§" required></textarea>

            <label for="shareLink">é€£çµ</label>
            <input type="url" id="shareLink" placeholder="https://..." required>

            <button class="btn primary" type="submit">æ–°å¢åˆ°å¾…é€æ¸…å–®</button>
          </form>

          <div class="family-share__list">
            <h4>å¾…é€å‡ºçš„åˆ†äº«</h4>
            <ul id="shareList"></ul>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="voice-settings-title">
        <h2 id="voice-settings-title">èªéŸ³åˆæˆè¨­å®š</h2>
        <p class="helper-text">
          é¸å–œæ­¡çš„ AI å¥¶å¥¶è²éŸ³ï¼Œè½èµ·ä¾†é †è€³å°±å¥½ã€‚
        </p>
        <div class="chat-preferences">
          <div class="chat-preferences__row chat-preferences__row--language">
            <span class="chat-preferences__label">èªéŸ³èªè¨€</span>
            <div class="language-toggle" data-language-options role="group" aria-label="èªéŸ³èªè¨€é¸æ“‡">
              <button type="button" class="language-chip is-selected" data-language-option="zh-TW" aria-pressed="true">åœ‹èª</button>
              <button type="button" class="language-chip" data-language-option="nan-TW" aria-pressed="false">å°èª</button>
            </div>
          </div>
        </div>
        <div class="voice-presets" data-voice-options role="radiogroup" aria-labelledby="voice-settings-title"></div>
        <p class="helper-text">ä¹‹å¾Œæƒ³æ›è²éŸ³ï¼Œå†å›ä¾†èª¿æ•´å³å¯ã€‚</p>
      </section>

      <section class="card" aria-labelledby="setup-form-title">
        <h2 id="setup-form-title">è¨­å®šå‘å°</h2>
        <form>
          <div>
            <label for="reminder-scenario">æé†’æƒ…å¢ƒ</label>
            <select id="reminder-scenario" name="reminder-scenario">
              <option>æ—©é¤å¾Œæé†’æˆ‘åƒè¡€å£“è—¥</option>
              <option>æ¯é€±ä¸‰æé†’ç¹³æ°´è²»</option>
              <option>é€±æ—¥æé†’èˆ‡å®¶äººè¦–è¨Š</option>
            </select>
          </div>

          <div>
            <label for="check-in-time">æ¯æ—¥é—œæ‡·æ™‚é–“</label>
            <input id="check-in-time" name="check-in-time" type="time" value="09:00">
            <p class="helper-text">ç³»çµ±æœƒåœ¨æ­¤æ™‚é–“å•å€™ä¸¦é€šçŸ¥å®¶äººã€‚</p>
          </div>

          <div>
            <label for="emergency-contact">ç·Šæ€¥è¯çµ¡äºº</label>
            <input id="emergency-contact" name="emergency-contact" type="tel" placeholder="è«‹è¼¸å…¥é›»è©±ï¼Œä¾‹å¦‚ï¼š0912-345-678">
          </div>

          <div>
            <label for="safe-zone">å®‰å…¨ç¯„åœ</label>
            <select id="safe-zone" name="safe-zone">
              <option>ä½å®¶å‘¨é‚Š 1 å…¬é‡Œ</option>
              <option selected>ä½å®¶å‘¨é‚Š 2 å…¬é‡Œ</option>
              <option>è‡ªè¨‚è·é›¢</option>
            </select>
          </div>

          <div>
            <label for="mobility">ä»Šæ—¥æ´»å‹•ç›®æ¨™</label>
            <select id="mobility" name="mobility">
              <option>æ­¥è¡Œ 2000 æ­¥</option>
              <option selected>æ­¥è¡Œ 3500 æ­¥</option>
              <option>å®¤å…§ä¼¸å±• 15 åˆ†é˜</option>
            </select>
          </div>

          <button class="btn primary" type="submit">å„²å­˜è¨­å®š</button>
        </form>
      </section>
    </main>

    <footer>
      <p>Â© 2025 NCCU=MIS+STAT</p>
    </footer>
  </div>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/settings.js"></script>
  <script src="assets/js/toast.js"></script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
  <script type="module">
    import {
      initLeafletMap,
      geocodeAddressViaNominatim,
      getStoredHome,
      saveHome,
      TAIWAN_REGIONS
    } from './assets/js/safety-map.js'

    const STORAGE_KEYS = {
      FAMILY_SHARES: 'ai-companion.pendingFamilyShares'
    }

    function initHomeLocationCard () {
    const feedbackEl = document.getElementById('homeFeedback')
    const storedInfoEl = document.getElementById('homeStoredInfo')
    const searchBtn = document.getElementById('homeSearchBtn')
    const saveBtn = document.getElementById('homeSaveBtn')
    const countySelect = document.getElementById('homeCountySelect')
    const districtSelect = document.getElementById('homeDistrictSelect')
    const detailInput = document.getElementById('homeAddressDetail')

    let previewMarker = null
    let latestResult = null
    let resolvedLocation = null
    let isSearching = false
    let lastSearchTs = 0
    const SEARCH_GAP_MS = 1000

    const { map, L } = initLeafletMap('home-map')

    function populateCounties () {
      const counties = Object.keys(TAIWAN_REGIONS).sort((a, b) => a.localeCompare(b))
      for (const county of counties) {
        const option = document.createElement('option')
        option.value = county
        option.textContent = county
        countySelect.appendChild(option)
      }
    }

    function populateDistricts (county, presetValue) {
      districtSelect.innerHTML = ''
      if (!county || !TAIWAN_REGIONS[county]) {
        districtSelect.disabled = true
        districtSelect.setAttribute('disabled', 'disabled')
        const opt = document.createElement('option')
        opt.value = ''
        opt.textContent = 'è«‹å…ˆé¸æ“‡ç¸£å¸‚'
        districtSelect.appendChild(opt)
        return
      }
      const opt = document.createElement('option')
      opt.value = ''
      opt.textContent = 'è«‹é¸æ“‡é„‰é®å¸‚å€'
      districtSelect.appendChild(opt)

      const districts = [...TAIWAN_REGIONS[county]].sort((a, b) => a.localeCompare(b))
      for (const district of districts) {
        const option = document.createElement('option')
        option.value = district
        option.textContent = district
        districtSelect.appendChild(option)
      }
      districtSelect.disabled = false
      districtSelect.removeAttribute('disabled')
      if (presetValue && districts.includes(presetValue)) {
        districtSelect.value = presetValue
      }
    }

    populateCounties()

    const existing = getStoredHome()
    if (existing) {
      storedInfoEl.textContent = `ç›®å‰å„²å­˜åœ°å€ï¼š${existing.address}`
      resolvedLocation = { lat: existing.lat, lon: existing.lon }
      updateMarkerPosition(existing.lat, existing.lon)
      map.setView([existing.lat, existing.lon], 15)
      saveBtn.disabled = false
      showFeedback('å¯æ‹–æ›³ç´…è‰²åœ–é‡˜æˆ–é»æ“Šåœ°åœ–å¾®èª¿ä½ç½®å¾Œå†å„²å­˜ã€‚')

      const counties = Object.keys(TAIWAN_REGIONS)
      const matchedCounty = counties.find(county => existing.address.includes(county))
      if (matchedCounty) {
        countySelect.value = matchedCounty
        populateDistricts(matchedCounty)
        const matchedDistrict = TAIWAN_REGIONS[matchedCounty].find(d => existing.address.includes(d))
        if (matchedDistrict) {
          districtSelect.value = matchedDistrict
          const detailText = existing.address
            .replace(matchedCounty, '')
            .replace(matchedDistrict, '')
            .trim()
          if (detailText && !detailInput.value) {
            detailInput.value = detailText
          }
        }
      }
    } else {
      storedInfoEl.textContent = 'å°šæœªå„²å­˜ä½å®¶åœ°å€ï¼Œè«‹å…ˆæœå°‹å¾Œå„²å­˜ã€‚'
    }

    function showFeedback (message, variant = 'info') {
      feedbackEl.textContent = message
      feedbackEl.hidden = false
      feedbackEl.classList.toggle('map-feedback--error', variant === 'error')
    }

    function clearFeedback () {
      feedbackEl.hidden = true
      feedbackEl.textContent = ''
      feedbackEl.classList.remove('map-feedback--error')
    }

    function onMarkerDragEnd (event) {
      const { lat, lng } = event.target.getLatLng()
      resolvedLocation = { lat, lon: lng }
      saveBtn.disabled = false
      showFeedback('å·²æ›´æ–°å®šä½ï¼Œå¯ç¹¼çºŒæ‹–æ›³æˆ–é»æ“Šåœ°åœ–èª¿æ•´ï¼Œç¢ºèªå¾Œè«‹æŒ‰ã€Œå„²å­˜ä½å®¶åœ°å€ã€ã€‚')
    }

    function onMapClick (event) {
      if (!previewMarker) return
      updateMarkerPosition(event.latlng.lat, event.latlng.lng, { openPopup: false })
      resolvedLocation = { lat: event.latlng.lat, lon: event.latlng.lng }
      saveBtn.disabled = false
      showFeedback('å·²æ›´æ–°å®šä½ï¼Œå¯ç¹¼çºŒæ‹–æ›³æˆ–é»æ“Šåœ°åœ–èª¿æ•´ï¼Œç¢ºèªå¾Œè«‹æŒ‰ã€Œå„²å­˜ä½å®¶åœ°å€ã€ã€‚')
    }

    function updateMarkerPosition (lat, lon, { openPopup = true } = {}) {
      if (previewMarker) {
        previewMarker.off('dragend', onMarkerDragEnd)
        previewMarker.setLatLng([lat, lon])
      } else {
        previewMarker = L.marker([lat, lon], {
          title: 'ä½å®¶ä½ç½®',
          draggable: true,
          icon: L.divIcon({
            className: 'home-marker',
            html: '<span class="home-marker__icon">ğŸ </span>',
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
          })
        })
          .addTo(map)
          .bindPopup('ä½å®¶ä½ç½®')
      }
      if (openPopup) {
        previewMarker.openPopup()
      }
      previewMarker.on('dragend', onMarkerDragEnd)
      map.off('click', onMapClick)
      map.on('click', onMapClick)
    }

    function removeMarker () {
      if (previewMarker) {
        previewMarker.off('dragend', onMarkerDragEnd)
        map.removeLayer(previewMarker)
        previewMarker = null
      }
      map.off('click', onMapClick)
      resolvedLocation = null
    }

    async function handleSearch () {
      if (isSearching) return

      const now = Date.now()
      if (now - lastSearchTs < SEARCH_GAP_MS) {
        showFeedback('è«‹ç¨å€™å†æŸ¥è©¢ã€‚')
        return
      }

      const county = countySelect.value.trim()
      const district = districtSelect.value.trim()
      const detail = detailInput.value.trim()

      if (!county) {
        showFeedback('è«‹å…ˆé¸æ“‡ç¸£å¸‚ã€‚', 'error')
        return
      }
      if (!district) {
        showFeedback('è«‹å…ˆé¸æ“‡é„‰é®å¸‚å€ã€‚', 'error')
        return
      }
      if (!detail) {
        showFeedback('è«‹è£œå……ä½å®¶è©³ç´°åœ°å€ã€‚', 'error')
        return
      }

      isSearching = true
      lastSearchTs = now
      saveBtn.disabled = true
      showFeedback('æ­£åœ¨æŸ¥è©¢ä½ç½®â€¦')

      try {
        const result = await geocodeAddressViaNominatim({ county, district, detail })
        if (!result) {
          latestResult = null
          resolvedLocation = null
          showFeedback('æ‰¾ä¸åˆ°æ­¤åœ°å€ï¼Œè«‹ç¢ºèªå¾Œå†è©¦ã€‚', 'error')
          removeMarker()
          return
        }

        latestResult = result
        resolvedLocation = { lat: result.lat, lon: result.lon }
        clearFeedback()
        showFeedback(`å·²æ‰¾åˆ°ï¼š${result.displayName}
è«‹ç¢ºèªåœ°åœ–ä½ç½®ï¼Œå¯æ‹–æ›³æˆ–é»æ“Šåœ°åœ–å¾®èª¿å¾Œå†å„²å­˜ã€‚`)
        updateMarkerPosition(result.lat, result.lon)
        map.setView([result.lat, result.lon], 16)
        saveBtn.disabled = false
        saveBtn.focus()
      } catch (error) {
        console.error('Home geocode failed', error)
        latestResult = null
        resolvedLocation = null
        showFeedback('æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error')
        removeMarker()
      } finally {
        isSearching = false
      }
    }

    async function handleSave () {
      const county = countySelect.value.trim()
      const district = districtSelect.value.trim()
      const detail = detailInput.value.trim()

      if (!county || !district || !detail) {
        showFeedback('è«‹å…ˆå®Œæˆåœ°å€é¸æ“‡èˆ‡æŸ¥è©¢ã€‚', 'error')
        return
      }

      const coords = resolvedLocation ?? (latestResult
        ? { lat: latestResult.lat, lon: latestResult.lon }
        : null)
      if (!coords) {
        showFeedback('è«‹å…ˆåœ¨åœ°åœ–ä¸Šç¢ºèªä½å®¶ä½ç½®ã€‚', 'error')
        return
      }

      try {
        const formattedAddress = `${county}${district}${detail}`
        saveHome({
          address: formattedAddress,
          lat: coords.lat,
          lon: coords.lon
        })
        storedInfoEl.textContent = `ç›®å‰å„²å­˜åœ°å€ï¼š${formattedAddress}`
        showFeedback('å·²å„²å­˜ä½å®¶åœ°å€ã€‚')
        saveBtn.disabled = true
        if (window.showToast) {
          window.showToast('å·²å„²å­˜ä½å®¶åœ°å€ã€‚', { variant: 'success' })
        }
      } catch (error) {
        console.error('Save home failed', error)
        showFeedback('å„²å­˜ä½å®¶åœ°å€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error')
      }
    }

    countySelect.addEventListener('change', () => {
      populateDistricts(countySelect.value)
      districtSelect.value = ''
      detailInput.value = ''
      saveBtn.disabled = true
      latestResult = null
      resolvedLocation = null
      removeMarker()
      clearFeedback()
    })

    districtSelect.addEventListener('change', () => {
      detailInput.value = ''
      saveBtn.disabled = true
      latestResult = null
      resolvedLocation = null
      removeMarker()
      clearFeedback()
    })

    detailInput.addEventListener('input', () => {
      saveBtn.disabled = true
      latestResult = null
      resolvedLocation = null
      removeMarker()
      clearFeedback()
    })
    searchBtn.addEventListener('click', handleSearch)
    saveBtn.addEventListener('click', handleSave)
    }

    function hideHomeLocationCard () {
      const card = document.getElementById('home-location-card')
      if (card) {
        card.hidden = true
        card.setAttribute('aria-hidden', 'true')
      }
    }

    const activeRole = window.aiCompanion?.getActiveRole?.() || ''
    const normalizedRole = window.aiCompanion?.normalizeRole?.(activeRole) || activeRole || ''
    const elderRoles = ['elder', 'senior', 'grandpa', 'grandma']
    const isElderRole = elderRoles.includes(normalizedRole.toLowerCase())

    if (isElderRole) {
      hideHomeLocationCard()
    } else {
      initHomeLocationCard()
    }

    function initFamilyCard () {
      const card = document.getElementById('family-setup-card')
      if (!card) return

      const shareForm = document.getElementById('familyShareForm')
      const shareList = document.getElementById('shareList')
      const statusPill = document.getElementById('fbStatusPill')
      const statusText = document.getElementById('fbStatusText')
      const connectBtn = document.querySelector('[data-facebook-connect]')

      const readShares = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.FAMILY_SHARES)
          const list = raw ? JSON.parse(raw) : []
          return Array.isArray(list) ? list : []
        } catch {
          return []
        }
      }

      const persistShares = (items) => {
        localStorage.setItem(STORAGE_KEYS.FAMILY_SHARES, JSON.stringify(items))
        renderShares()
      }

      const renderShares = () => {
        if (!shareList) return
        const items = readShares()
        shareList.innerHTML = ''
        if (!items.length) {
          const li = document.createElement('li')
          li.className = 'family-share__empty'
          li.textContent = 'ç›®å‰å°šç„¡å¾…é€å‡ºçš„åˆ†äº«ã€‚'
          shareList.appendChild(li)
          return
        }
        items.forEach(item => {
          const li = document.createElement('li')
          li.innerHTML = `
            <strong>${item.name}</strong>
            <p>${item.summary}</p>
            <a href="${item.link}" target="_blank" rel="noopener">${item.link}</a>
            <button type="button" class="link-button" data-remove="${item.id}">ç§»é™¤</button>
          `
          shareList.appendChild(li)
        })
      }

      shareList?.addEventListener('click', (event) => {
        const target = event.target.closest('[data-remove]')
        if (!target) return
        const id = target.getAttribute('data-remove')
        const next = readShares().filter(item => item.id !== id)
        persistShares(next)
      })

      shareForm?.addEventListener('submit', (event) => {
        event.preventDefault()
        const name = document.getElementById('shareName')?.value.trim()
        const summary = document.getElementById('shareSummary')?.value.trim()
        const link = document.getElementById('shareLink')?.value.trim()
        if (!name || !summary || !link) {
          alert('è«‹å®Œæ•´å¡«å¯«åˆ†äº«è³‡è¨Š')
          return
        }
        const payload = { id: `${Date.now()}`, name, summary, link }
        const list = readShares()
        list.unshift(payload)
        persistShares(list)
        shareForm.reset()
      })

      renderShares()

      async function checkFacebookStatus () {
        if (!window.aiCompanion?.fetchJson || !statusPill || !statusText) return
        try {
          const data = await window.aiCompanion.fetchJson('/facebook/posts?limit=1')
          if (data?.disabled) {
            statusPill.textContent = 'å°šæœªæˆæ¬Š'
            statusPill.classList.remove('status-pill--ok')
            statusPill.classList.add('status-pill--warn')
            statusText.textContent = 'å°šæœªé‚€è«‹ä»»ä½•å®¶äººæˆæ¬Šï¼Œè«‹å…ˆé€å‡ºé‚€è«‹ã€‚'
          } else {
            statusPill.textContent = 'æˆæ¬Šæ­£å¸¸'
            statusPill.classList.remove('status-pill--warn')
            statusPill.classList.add('status-pill--ok')
            statusText.textContent = 'å·²åµæ¸¬åˆ°å®¶äººæˆæ¬Šï¼Œæœƒè‡ªå‹•åŒæ­¥è²¼æ–‡ã€‚'
          }
        } catch (error) {
          statusPill.textContent = 'æª¢æŸ¥å¤±æ•—'
          statusPill.classList.remove('status-pill--ok')
          statusPill.classList.add('status-pill--warn')
          statusText.textContent = 'ç„¡æ³•æª¢æŸ¥æˆæ¬Šç‹€æ…‹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'
          console.warn('[settings] fetch facebook status failed', error)
        }
      }

      checkFacebookStatus()
    }

    document.addEventListener('DOMContentLoaded', () => {
      initFamilyCard()
    })

    document.addEventListener('DOMContentLoaded', () => {
      const connectBtn = document.querySelector('[data-facebook-connect]')
      if (connectBtn) {
        connectBtn.addEventListener('click', async () => {
          if (!window.aiCompanion?.fetchJson) return
          connectBtn.disabled = true
          connectBtn.textContent = 'å‰å¾€ Facebook ä¸­â€¦'
          try {
            const data = await window.aiCompanion.fetchJson('/facebook/auth/url')
            if (data?.url) {
              window.location.href = data.url
            } else {
              throw new Error('missing_url')
            }
          } catch (error) {
            console.warn('[settings] ç„¡æ³•å–å¾— Facebook OAuth URL', error)
            alert('ç„¡æ³•å•Ÿå‹• Facebook æˆæ¬Šï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚')
            connectBtn.disabled = false
            connectBtn.textContent = 'é€£çµ Facebook'
          }
        })
      }

      const params = new URLSearchParams(window.location.search)
      const fbStatus = params.get('facebook') || params.get('status')
      if (fbStatus === 'success' && window.showToast) {
        window.showToast('Facebook æˆæ¬ŠæˆåŠŸï¼Œç¨å¾Œå°‡è‡ªå‹•åŒæ­¥è²¼æ–‡ã€‚', { variant: 'success' })
        params.delete('facebook')
        params.delete('status')
        params.delete('message')
        const newUrl = `${window.location.pathname}${params.toString() ? `?${params.toString()}` : ''}${window.location.hash}`
        window.history.replaceState({}, '', newUrl)
      } else if (fbStatus && fbStatus !== 'success' && window.showToast) {
        window.showToast('Facebook æˆæ¬Šå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚', { variant: 'error' })
        params.delete('facebook')
        params.delete('status')
        params.delete('message')
        const newUrl = `${window.location.pathname}${params.toString() ? `?${params.toString()}` : ''}${window.location.hash}`
        window.history.replaceState({}, '', newUrl)
      }
    })
  </script>
  <script>
    (function initAccountSettings(){
      const API_BASE = (localStorage.getItem('AI_COMPANION_API_BASE') || 'http://localhost:3001').replace(/\/$/, '')
      const ELDER_MATCH = ['elder', 'senior', 'grandpa', 'grandma']

      const resolveActiveRole = () => {
        const raw = window.aiCompanion?.getActiveRole?.() || ''
        const normalized = window.aiCompanion?.normalizeRole?.(raw) || raw || ''
        return normalized.toLowerCase()
      }

      const isElderLocked = () => ELDER_MATCH.includes(resolveActiveRole())

      function insertElderNotice () {
        const existing = document.getElementById('elder-lock-card')
        if (existing) return existing
        const main = document.querySelector('main')
        if (!main) return null
        const notice = document.createElement('section')
        notice.className = 'card'
        notice.id = 'elder-lock-card'
        notice.innerHTML = `
          <h2>ç”±å®¶å±¬å”åŠ©ç®¡ç†</h2>
          <p class="helper-text">æ­¤é é¢çš„ä½å®¶ä½ç½®èˆ‡å¸³è™Ÿè³‡è¨Šåƒ…ä¾›å®¶å±¬æˆ–ç…§è­·è€…èª¿æ•´ã€‚å¦‚éœ€æ›´æ–°ï¼Œè«‹èˆ‡å®¶å±¬è¯ç¹«ã€‚</p>
        `
        const anchor = document.getElementById('voice-settings-title')?.closest('section')
        if (anchor) {
          main.insertBefore(notice, anchor)
        } else {
          main.appendChild(notice)
        }
        return notice
      }

      async function fetchMe() {
        try {
          const res = await fetch(`${API_BASE}/api/users/me`, { credentials: 'include' })
          if (!res.ok) {
            location.href = 'login.html?error=login_required'
            return null
          }
          const { user } = await res.json()
          return user
        } catch {
          location.href = 'login.html?error=login_required'
          return null
        }
      }

      function ensureForms() {
        // Account profile form (create if missing)
        let profileCard = document.getElementById('account-card')
        if (!profileCard) {
          const main = document.querySelector('main') || document.body
          profileCard = document.createElement('section')
          profileCard.className = 'card'
          profileCard.id = 'account-card'
          profileCard.innerHTML = `
            <h2>å¸³è™Ÿè³‡è¨Š</h2>
            <form id="profileForm">
              <div><label>å§“å</label><input id="full_name" name="full_name" type="text"></div>
              <div><label>é›»å­éƒµä»¶</label><input id="email" name="email" type="email"></div>
              <div><label>ä½¿ç”¨è€…åç¨±</label><input id="username" name="username" type="text"></div>
              <div><label>å¹´é½¡</label><input id="age" name="age" type="number" min="0"></div>
              <div><label>é›»è©±</label><input id="phone" name="phone" type="tel"></div>
              <div><label>åœ°å€</label><input id="address" name="address" type="text"></div>
              <button class="btn primary" type="submit">å„²å­˜</button>
            </form>`
          main.appendChild(profileCard)
        }

        let pwCard = document.getElementById('password-card')
        if (!pwCard) {
          const main = document.querySelector('main') || document.body
          pwCard = document.createElement('section')
          pwCard.className = 'card'
          pwCard.id = 'password-card'
          pwCard.innerHTML = `
            <h2>è®Šæ›´å¯†ç¢¼</h2>
            <form id="passwordForm">
              <div><label>ç›®å‰å¯†ç¢¼</label><input id="currentPassword" name="currentPassword" type="password" required></div>
              <div><label>æ–°å¯†ç¢¼</label><input id="newPassword" name="newPassword" type="password" required></div>
              <div><label>ç¢ºèªæ–°å¯†ç¢¼</label><input id="confirmNewPassword" name="confirmNewPassword" type="password" required></div>
              <button class="btn primary" type="submit">æ›´æ–°å¯†ç¢¼</button>
            </form>`
          main.appendChild(pwCard)
        }
      }

      async function bootstrap() {
        const locked = isElderLocked()
        if (locked) {
          insertElderNotice()
          const homeCard = document.getElementById('home-location-card')
          if (homeCard) {
            homeCard.hidden = true
            homeCard.setAttribute('aria-hidden', 'true')
          }
        } else {
          ensureForms()
        }
        const user = await fetchMe()
        if (!user || locked) return
        // Fill profile fields
        const byId = (id) => document.getElementById(id)
        if (byId('full_name')) byId('full_name').value = user.full_name || ''
        if (byId('email')) byId('email').value = user.email || ''
        if (byId('username')) byId('username').value = user.username || ''
        if (byId('age')) byId('age').value = user.age ?? ''
        if (byId('phone')) byId('phone').value = user.phone || ''
        if (byId('address')) byId('address').value = user.address || ''

        // Bind submit events
        const profileForm = document.getElementById('profileForm')
        if (profileForm) profileForm.addEventListener('submit', async (e) => {
          e.preventDefault()
          const payload = Object.fromEntries(new FormData(profileForm).entries())
          // Clean empty strings to undefined so PATCH can detect
          Object.keys(payload).forEach(k => { if (payload[k] === '') delete payload[k] })
          try {
            const res = await fetch(`${API_BASE}/api/users/me`, {
              method: 'PATCH', headers: { 'Content-Type': 'application/json' },
              credentials: 'include', body: JSON.stringify(payload)
            })
            if (res.ok) { if (window.showToast) showToast('å·²æ›´æ–°', { variant: 'success' }); location.reload() }
            else {
              const err = await res.json().catch(()=>({}))
              const msg = err.error === 'email_taken' ? 'Email å·²è¢«ä½¿ç”¨' : err.error === 'username_taken' ? 'ä½¿ç”¨è€…åç¨±å·²è¢«ä½¿ç”¨' : 'æ›´æ–°å¤±æ•—'
              if (window.showToast) showToast(msg, { variant: 'error' }); else alert(msg)
            }
          } catch { alert('æ›´æ–°å¤±æ•—') }
        })

        const passwordForm = document.getElementById('passwordForm')
        if (passwordForm) passwordForm.addEventListener('submit', async (e) => {
          e.preventDefault()
          const currentPassword = document.getElementById('currentPassword').value
          const newPassword = document.getElementById('newPassword').value
          const confirm = document.getElementById('confirmNewPassword').value
          if (!newPassword || newPassword.length < 8) { alert('æ–°å¯†ç¢¼è‡³å°‘ 8 ç¢¼'); return }
          if (newPassword !== confirm) { alert('æ–°å¯†ç¢¼èˆ‡ç¢ºèªä¸ä¸€è‡´'); return }
          try {
            const res = await fetch(`${API_BASE}/api/auth/change-password`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              credentials: 'include', body: JSON.stringify({ currentPassword, newPassword })
            })
            if (res.ok) { if (window.showToast) showToast('å·²æ›´æ–°å¯†ç¢¼ï¼Œè«‹é‡æ–°ç™»å…¥', { variant: 'success' }); location.href = 'login.html?error=login_required' }
            else {
              const err = await res.json().catch(()=>({}))
              const msg = err.error === 'wrong_password' ? 'ç›®å‰å¯†ç¢¼ä¸æ­£ç¢º' : 'æ›´æ–°å¤±æ•—'
              if (window.showToast) showToast(msg, { variant: 'error' }); else alert(msg)
            }
          } catch { alert('æ›´æ–°å¤±æ•—') }
        })
      }

      document.addEventListener('DOMContentLoaded', bootstrap)
    })()
  </script>
</body>
</html>
