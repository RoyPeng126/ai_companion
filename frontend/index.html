<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºè­·ç”Ÿæ´»ï¼šAI ä¼´ä½ </title>
  <!-- CSS -->
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <link rel="stylesheet" href="assets/css/safety-map.css">
  <script>
    // é¦–è¨ªå°åˆ° welcome
    (function () {
      const storageKey = 'ai-companion-skip-welcome'
      const fromWelcome = document.referrer && document.referrer.includes('welcome.html')
      try {
        if (!fromWelcome && !sessionStorage.getItem(storageKey)) {
          sessionStorage.setItem(storageKey, 'true')
          window.location.replace('welcome.html')
        }
      } catch (error) {
        if (!fromWelcome) window.location.replace('welcome.html')
      }
    })()
  </script>
</head>
<body>
  <div class="app-shell">
    <header class="top-bar" aria-label="ä¸»è¦å°è¦½">
      <div class="brand">
        <span class="brand-logo" aria-hidden="true">
        <img src="assets/image/logo.jpg" alt="AI Logo" class="logo-img">
        </span>
        <h1>æ™ºè­·ç”Ÿæ´»ï¼šAI ä¼´ä½ </h1>
      </div>
      <button class="menu-toggle" type="button" aria-controls="site-nav" aria-expanded="false" data-menu-toggle>
        <span class="sr-only">åˆ‡æ›å°è¦½é¸å–®</span>
        <span class="hamburger" aria-hidden="true"></span>
      </button>
      <nav id="site-nav" class="nav-links" data-menu>
        <a href="index.html" aria-current="page">é¦–é </a>
        <a href="selection.html">é™ªä¼´è¨­å®š</a>
        <a href="setting.html">å¿«é€Ÿè¨­å®š</a>
        <a href="ranking.html">å¥åº·æ’è¡Œæ¦œ</a>
        <a href="forum.html">ç¤¾ç¾¤å…¬åœ’</a>
        <a href="guide.html">é›¢ç·šå¹«åŠ©æŒ‡å—</a>
      </nav>
      <div class="user-menu" id="userMenu" aria-label="ä½¿ç”¨è€…é¸å–®">
        <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false" title="ä½¿ç”¨è€…é¸å–®">
          <span class="sr-only">é–‹å•Ÿä½¿ç”¨è€…é¸å–®</span>
          <span class="avatar-frame">
            <img class="avatar-image" id="avatarImage" alt="ä½¿ç”¨è€…é ­åƒ" hidden>
            <span class="avatar-initials" id="avatarInitials">U</span>
          </span>
        </button>
        <div class="menu-dropdown" id="userDropdown" hidden>
          <div class="user-header">
            <div class="user-name" id="umName">ä½¿ç”¨è€…</div>
            <div class="user-email" id="umEmail"></div>
          </div>
          <a class="menu-item" href="setting.html" id="umAccount">å¸³è™Ÿè¨­å®š</a>
          <button class="menu-item" id="umLogout" type="button">ç™»å‡º</button>
        </div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div>
          <p class="status-pill">é«˜é½¡å‹å–„ï¼æƒ…æ„Ÿé™ªä¼´ï¼å®‰å…¨å®ˆè­·</p>
          <h2>è®“é™ªä¼´èˆ‡æé†’æˆç‚ºç”Ÿæ´»ä¸€éƒ¨åˆ†</h2>
        </div>
      </section>

      <section class="grid two" aria-label="å¿«é€Ÿæ“ä½œ">
        <article class="card">
          <h3>ä»Šæ—¥é‡é»æé†’</h3>
          <ul class="list" id="today-list"></ul>
          <p class="helper-text">æé†’ä¾†æºå¯ç”±é•·è€…èªéŸ³æ–°å¢æˆ–å®¶å±¬é ç«¯åŒæ­¥ã€‚</p>
        </article>

        <article class="card" id="safety-card">
          <h3>å®‰å…¨æ¦‚æ³</h3>
          <div class="safety-status" id="safetyStatus">
            <span class="status-chip status-chip--alert" id="safetyChip">å°šæœªè¨­å®š</span>
            <p class="safety-status__summary" id="safetySummary">å°šæœªè¨­å®šä½å®¶åœ°å€ã€‚</p>
            <p class="info-text" id="safetyDetail">è«‹å‰å¾€å¿«é€Ÿè¨­å®šé é¢å„²å­˜ä½å®¶ä½ç½®ï¼Œä»¥å•Ÿç”¨å®‰å…¨ç¯„åœæé†’ã€‚</p>
            <a class="btn secondary" id="safetySetupBtn" href="setting.html">å‰å¾€è¨­å®š</a>
            <p class="map-feedback map-feedback--error" id="safetyWarning" hidden></p>
          </div>
          <div id="safety-map" aria-label="å®‰å…¨åœ°åœ–"></div>
          <p class="helper-text">å¤–å‡ºæ™‚æœƒåµæ¸¬èˆ‡ä½å®¶çš„è·é›¢ï¼Œè¶…é 2 å…¬é‡Œå°‡é€šçŸ¥å®¶å±¬ã€‚</p>
        </article>
      </section>

      <section class="grid two" aria-label="ç¤¾äº¤èˆ‡å›æ†¶">
        <article class="card">
          <h3>å®¶æ—æš–å¿ƒå›é¥‹</h3>
          <div class="chat-window" data-ai-chat>
            <div class="voice-selection">
              <div class="chat-preferences">
                <div class="chat-preferences__row">
                  <label for="persona-selector">é™ªèŠè§’è‰²</label>
                  <select id="persona-selector" name="persona-selector">
                    <option value="child">æ´»åŠ›ç«¥å¹´ç‰ˆ</option>
                    <option value="adult">æº«æŸ”é’å£¯ç‰ˆ</option>
                    <option value="senior">æ™ºæ…§é•·è€…ç‰ˆ</option>
                  </select>
                </div>
                <p id="chat-persona" class="helper-text">ç›®å‰é™ªèŠå¤¥ä¼´ï¼šæ™ºæ…§é•·è€…ç‰ˆ</p>
                <div class="chat-preferences__row chat-preferences__row--language">
                  <span class="chat-preferences__label">èªéŸ³èªè¨€</span>
                  <div class="language-toggle" data-language-options role="group" aria-label="èªéŸ³èªè¨€é¸æ“‡">
                    <button type="button" class="language-chip is-selected" data-language-option="zh-TW" aria-pressed="true">åœ‹èª</button>
                    <button type="button" class="language-chip" data-language-option="nan-TW" aria-pressed="false">å°èª</button>
                  </div>
                </div>
              </div>
            <div class="chat-log" id="chat-log" aria-live="polite"></div>
            <div id="chat-status" class="chat-status helper-text" role="status" aria-live="assertive"></div>
            <div class="voice-memos" aria-label="èªéŸ³å‚™å¿˜éŒ„">
              <div class="voice-memos-header">
                <h4>èªéŸ³å‚™å¿˜éŒ„</h4>
                <button id="clear-memos" class="link-button" type="button">æ¸…é™¤</button>
              </div>
              <ul id="memo-list" class="memo-list"></ul>
            </div>
            <div class="chat-input">
              <label class="sr-only" for="chat-message">è¼¸å…¥è¨Šæ¯</label>
              <textarea id="chat-message" aria-label="è¼¸å…¥è¨Šæ¯" placeholder="èªªèªªä»Šå¤©æƒ³èŠçš„äº‹..." rows="2"></textarea>
              <div class="chat-actions">
                <button class="btn icon-only voice-button" type="button" id="record-toggle" aria-label="é–‹å§‹éŒ„éŸ³">
                  <svg class="icon" viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 15.5a3.5 3.5 0 0 0 3.5-3.5V6a3.5 3.5 0 0 0-7 0v6a3.5 3.5 0 0 0 3.5 3.5Zm5-3.5a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V22h2v-3.08A7 7 0 0 0 19 12h-2Z"/></svg>
                  <span class="sr-only" data-record-label>é–‹å§‹éŒ„éŸ³</span>
                </button>
                <button class="btn primary send-button" type="button" id="send-text">
                  <svg class="icon" viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false"><path fill="currentColor" d="m17.27 10.74-8.02-4.67a1 1 0 0 0-1.49.86v9.14a1 1 0 0 0 1.5.86l8.02-4.47a1 1 0 0 0-.01-1.72Zm-7.51 3.61V9.66L14.78 12l-5.02 2.35Z"/></svg>
                  <span>å‚³é€</span>
                </button>
              </div>
            </div>
            <p class="helper-text">æŒ‰ä¸‹ã€Œé–‹å§‹éŒ„éŸ³ã€èªªå‡ºæƒ³æé†’çš„äº‹ï¼Œç³»çµ±å¯è½‰æˆå‚™å¿˜éŒ„ï¼Œä¸¦ç”± AI å¤¥ä¼´èªéŸ³å›è¦†ã€‚</p>
          </div>
        </article>
        <article class="card">
          <h3>ç¤¾å€äº’å‹•</h3>
          <p>æ¯é€±äº”æ™šä¸Š 8 é»èˆ‡å®¶äººè¦–è¨Šã€æ¯é€±æ—¥åˆ†äº«æ•£æ­¥ç…§ç‰‡ï¼ŒAI å¥¶å¥¶æœƒæé†’ä¸¦çµ¦äºˆé¼“å‹µã€‚</p>
          <a class="btn secondary" href="forum.html">å‰å¾€ç¤¾ç¾¤å…¬åœ’</a>
        </article>
      </section>
    </main>

    <footer>
      <p>Â© 2025 NCCU=MIS+STATï¼ä»¥ç§‘æŠ€å¸¶ä¾†æœ‰æº«åº¦çš„é™ªä¼´</p>
    </footer>
  </div>

  <!-- JS é †åºï¼šå…ˆåŸºç¤ï¼Œå†åŠŸèƒ½æ¨¡çµ„ -->
  <script src="assets/js/app.js"></script>
  <script src="assets/js/settings.js"></script>
  <script src="assets/js/chat.js"></script>
  <script src="assets/js/reminders.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- å®‰å…¨åœ°åœ–æ¨¡çµ„ -->
  <script type="module">
    import { initLeafletMap, getStoredHome, haversineDistanceMeters, metersToKmString, SAFETY_RADIUS_METERS } from './assets/js/safety-map.js'
    const chipEl = document.getElementById('safetyChip')
    const summaryEl = document.getElementById('safetySummary')
    const detailEl = document.getElementById('safetyDetail')
    const setupBtn = document.getElementById('safetySetupBtn')
    const warningEl = document.getElementById('safetyWarning')
    const { map, L } = initLeafletMap('safety-map', { zoomControl: false })
    const homeIcon = L.divIcon({ className: 'home-marker', html: '<span class="home-marker__icon">ğŸ </span>', iconAnchor: [16, 32], popupAnchor: [0, -28] })
    let safetyCircle = null, homeMarker = null, userMarker = null, hasAlerted = false
    function setChipState (state) {
      chipEl.classList.remove('status-chip--alert', 'status-chip--safe')
      if (state === 'safe') { chipEl.classList.add('status-chip--safe'); chipEl.textContent = 'å®‰å…¨ç¯„åœå…§' }
      else if (state === 'alert') { chipEl.classList.add('status-chip--alert'); chipEl.textContent = 'å®‰å…¨è­¦ç¤º' }
      else { chipEl.classList.add('status-chip--alert'); chipEl.textContent = 'å°šæœªè¨­å®š' }
    }
    function clearWarning () { warningEl.hidden = true; warningEl.textContent = '' }
    function showWarning (m) { warningEl.hidden = false; warningEl.textContent = m }
    function renderNoHomeState () { setChipState('unset'); summaryEl.textContent = 'å°šæœªè¨­å®šä½å®¶åœ°å€ã€‚'; detailEl.textContent = 'è«‹å‰å¾€å¿«é€Ÿè¨­å®šé é¢å„²å­˜ä½å®¶ä½ç½®ï¼Œä»¥å•Ÿç”¨å®‰å…¨ç¯„åœæé†’ã€‚'; setupBtn.hidden = false; clearWarning() }
    function renderPendingLocation () { setChipState('safe'); summaryEl.textContent = 'æ­£åœ¨å–å¾—ç›®å‰ä½ç½®â€¦'; detailEl.textContent = 'å–å¾—å®šä½å¾Œå°‡æ›´æ–°èˆ‡ä½å®¶çš„è·é›¢ã€‚'; setupBtn.hidden = true; clearWarning() }
    function renderSafeState (distance) { setChipState('safe'); summaryEl.textContent = distance <= 30 ? 'æ‚¨ç›®å‰åœ¨å®¶ä¸­ã€‚' : 'æ‚¨ç›®å‰åœ¨å®‰å…¨ç¯„åœå…§ã€‚'; detailEl.textContent = `è·é›¢ä½å®¶ç´„ ${metersToKmString(distance)}ï¼Œå®‰å…¨ç¯„åœç‚º 2 å…¬é‡Œã€‚`; setupBtn.hidden = true; clearWarning() }
    function renderAlertState (distance) { setChipState('alert'); summaryEl.textContent = 'æ‚¨å·²è¶…å‡ºå®‰å…¨ç¯„åœï¼'; detailEl.textContent = `è·é›¢ä½å®¶ç´„ ${metersToKmString(distance)}ï¼Œè«‹å„˜é€Ÿé€šçŸ¥å®¶äººæˆ–è¿”å›å®‰å…¨å€åŸŸã€‚`; setupBtn.hidden = true; if (!hasAlerted) { alert('æ‚¨å·²è¶…å‡º 2 å…¬é‡Œå®‰å…¨ç¯„åœï¼'); hasAlerted = true } clearWarning() }
    function handleGeolocationError () { showWarning('ç„¡æ³•å–å¾—ç›®å‰ä½ç½®ï¼ˆå¯èƒ½å°šæœªæˆæ¬Šå®šä½ï¼‰ã€‚') }
    const home = getStoredHome()
    if (!home) { renderNoHomeState() } else {
      renderPendingLocation()
      if (homeMarker) map.removeLayer(homeMarker); if (safetyCircle) map.removeLayer(safetyCircle)
      homeMarker = L.marker([home.lat, home.lon], { title: 'ä½å®¶ä½ç½®', icon: homeIcon }).addTo(map).bindPopup('ä½å®¶ä½ç½®')
      safetyCircle = L.circle([home.lat, home.lon], { radius: SAFETY_RADIUS_METERS, color: '#f87171', fillColor: '#fca5a5', fillOpacity: 0.15, weight: 2, dashArray: '6 6' }).addTo(map)
      const bounds = safetyCircle.getBounds(); map.fitBounds(bounds, { padding: [28, 28] })
    }
    function renderUserLocation (coords) {
      if (userMarker) { map.removeLayer(userMarker); userMarker = null }
      if (home && safetyCircle) {
        const distance = haversineDistanceMeters(coords, [home.lat, home.lon])
        const bounds = safetyCircle.getBounds().extend(coords); map.fitBounds(bounds, { padding: [28, 28] })
        if (distance <= 30) { if (homeMarker) homeMarker.openPopup(); renderSafeState(distance); return }
        userMarker = L.marker(coords, { title: 'ç›®å‰ä½ç½®' }).addTo(map).bindPopup('ç›®å‰ä½ç½®'); userMarker.openPopup()
        if (distance <= SAFETY_RADIUS_METERS) renderSafeState(distance); else renderAlertState(distance); return
      }
      userMarker = L.marker(coords, { title: 'ç›®å‰ä½ç½®' }).addTo(map).bindPopup('ç›®å‰ä½ç½®'); userMarker.openPopup(); summaryEl.textContent = 'å·²å–å¾—ç›®å‰ä½ç½®ã€‚'; detailEl.textContent = 'è«‹åœ¨å¿«é€Ÿè¨­å®šé é¢å„²å­˜ä½å®¶åœ°å€ï¼Œä»¥å•Ÿç”¨å®‰å…¨æé†’ã€‚'; setupBtn.hidden = false; map.setView(coords, 15)
    }
    if ('geolocation' in navigator) { navigator.geolocation.getCurrentPosition((pos)=>renderUserLocation([pos.coords.latitude, pos.coords.longitude]), ()=>handleGeolocationError(), { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }) } else { showWarning('ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚') }
    if (!home) { map.setView([25.033, 121.5654], 13) }
  </script>

  <!-- æˆæ¬Šå®ˆé–€èˆ‡ä½¿ç”¨è€…é¸å–® -->
  <script>
    (async function guardAuth() {
      const API_BASE = (localStorage.getItem('AI_COMPANION_API_BASE') || 'http://localhost:3001').replace(/\/$/, '')
      try { const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' }); if (!res.ok) location.href = 'login.html?error=login_required' } catch { location.href = 'login.html?error=login_required' }
    })()
  </script>
  <script>
    (function initUserMenu(){
      const API_BASE = (localStorage.getItem('AI_COMPANION_API_BASE') || 'http://localhost:3001').replace(/\/$/, '')
      const btn = document.getElementById('avatarBtn'), dd = document.getElementById('userDropdown'), initialsEl = document.getElementById('avatarInitials'), avatarImg = document.getElementById('avatarImage'), nameEl = document.getElementById('umName'), emailEl = document.getElementById('umEmail'), logoutBtn = document.getElementById('umLogout')
      function toInitials(name){ if(!name) return 'U'; const parts=String(name).trim().split(/\s+/); return parts.length===1?parts[0].slice(0,2).toUpperCase():(parts[0][0]+parts[1][0]).toUpperCase() }
      async function loadUser(){ try { const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' }); if(!res.ok) return; const json = await res.json(); const user = json.user || {}; const display = user.full_name || user.username || user.email || 'ä½¿ç”¨è€…'; const avatarUrl = user.avatar_url || user.avatar; if(nameEl) nameEl.textContent = display; if(emailEl) emailEl.textContent = user.email || ''; if(initialsEl) initialsEl.textContent = toInitials(display); if(avatarImg){ if(avatarUrl){ avatarImg.src=avatarUrl; avatarImg.alt=`${display} çš„é ­åƒ`; avatarImg.hidden=false; if(initialsEl) initialsEl.hidden=true } else { avatarImg.removeAttribute('src'); avatarImg.hidden=true; if(initialsEl) initialsEl.hidden=false } } } catch {} }
      function openMenu(){ dd.hidden=false; btn.setAttribute('aria-expanded','true'); document.addEventListener('click', onDocClick); document.addEventListener('keydown', onEsc) }
      function closeMenu(){ dd.hidden=true; btn.setAttribute('aria-expanded','false'); document.removeEventListener('click', onDocClick); document.removeEventListener('keydown', onEsc) }
      function onDocClick(e){ if(!dd.contains(e.target) && !btn.contains(e.target)) closeMenu() }
      function onEsc(e){ if(e.key==='Escape') closeMenu() }
      if (btn) btn.addEventListener('click', (e)=>{ e.stopPropagation(); dd.hidden ? openMenu() : closeMenu() })
      if (logoutBtn) logoutBtn.addEventListener('click', async ()=>{ try { await fetch(`${API_BASE}/api/auth/logout`, { method:'POST', credentials:'include' }) } catch {} location.href='login.html?error=login_required' })
      loadUser()
    })()
  </script>

  <!-- å–®ä¸€ç‰ˆæœ¬ï¼šä»Šæ—¥é‡é»æé†’ï¼ˆæ¸²æŸ“/æ–°å¢/åˆªé™¤/å®Œæˆ/é€šçŸ¥ï¼‰ -->
  <script>
    (function initToday(){
      const TAIPEI_TZ = 'Asia/Taipei'
      function todayRangeInTaipei(){ const now = new Date(); const ymd = new Intl.DateTimeFormat('en-CA', { timeZone: TAIPEI_TZ, year:'numeric', month:'2-digit', day:'2-digit' }).format(now); const start = new Date(`${ymd}T00:00:00+08:00`); const end = new Date(start.getTime() + 24*60*60*1000); return { from: start.toISOString(), to: end.toISOString(), ymd } }
      async function renderToday(){ const listEl = document.getElementById('today-list'); if (!listEl) return; const range = todayRangeInTaipei(); const qs = new URLSearchParams({ from: range.from, to: range.to }).toString(); try { const data = await window.aiCompanion.fetchJson(`/events?${qs}`); const events = Array.isArray(data?.events) ? data.events : []; if (!events.length) { listEl.innerHTML = '<li><span>ä»Šå¤©å°šç„¡æé†’</span></li>'; return } listEl.innerHTML = ''; for (const ev of events) { const li = document.createElement('li'); const t = new Date(ev.start_time); const hh = String(t.getHours()).padStart(2,'0'); const mm = String(t.getMinutes()).padStart(2,'0'); const time = `${hh}:${mm}`; li.innerHTML = `<strong>${time}</strong><span>${(ev.title||'').toString()}</span><button class="btn secondary" data-del style="margin-left:auto">åˆªé™¤</button>`; li.title = ev.description || ''; li.style.cursor='pointer'; li.addEventListener('click', async ()=>{ try { await window.aiCompanion.fetchJson(`/events/${ev.id}`, { method:'PATCH', body: JSON.stringify({ status: !ev.status }) }); ev.status=!ev.status; li.style.opacity = ev.status ? '0.55' : '1' } catch {} }); li.querySelector('[data-del]').addEventListener('click', async (e)=>{ e.stopPropagation(); if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æé†’ï¼Ÿ')) return; try { await window.aiCompanion.fetchJson(`/events/${ev.id}`, { method:'DELETE' }); li.remove() } catch { alert('åˆªé™¤å¤±æ•—ï¼Œç¨å¾Œå†è©¦') } }); if (ev.status) li.style.opacity='0.55'; listEl.appendChild(li) } } catch (error) { listEl.innerHTML = '<li><span>è¼‰å…¥æé†’å¤±æ•—ï¼Œç¨å¾Œå†è©¦</span></li>'; console.warn('[today events] load failed', error) } }
      function scheduleNotifications(events){ if (!('Notification' in window)) return; if (Notification.permission !== 'granted') { Notification.requestPermission().catch(()=>{}) } const now = Date.now(); for (const ev of events) { const target = ev.reminder_time || ev.start_time; if (!target) continue; const at = Date.parse(target), delay = at - now; if (Number.isFinite(delay) && delay > 0 && delay <= 24*60*60*1000) { setTimeout(()=>{ try { if (Notification.permission==='granted') new Notification(ev.title || 'æé†’', { body: ev.description || 'æ™‚é–“åˆ°äº†', silent: false }) } catch {} }, delay) } } }
      async function loadAndScheduleToday(){ const range = todayRangeInTaipei(); const qs = new URLSearchParams({ from: range.from, to: range.to }).toString(); try { const data = await window.aiCompanion.fetchJson(`/events?${qs}`); const events = Array.isArray(data?.events) ? data.events : []; scheduleNotifications(events) } catch {} }
      function bindAddForm(){ const toggleBtn = document.getElementById('addEventBtn'), form = document.getElementById('addEventForm'), cancelBtn = document.getElementById('cancelAdd'), dateEl = document.getElementById('evtDate'), timeEl = document.getElementById('evtTime'), remindEl = document.getElementById('evtRemind'); const range = todayRangeInTaipei(); if (dateEl) dateEl.value = range.ymd; if (timeEl) timeEl.value = '09:00'; toggleBtn.addEventListener('click', ()=>{ form.style.display = form.style.display === 'none' ? 'block' : 'none' }); if (cancelBtn) cancelBtn.addEventListener('click', ()=>{ form.style.display='none' }); form.addEventListener('submit', async (e)=>{ e.preventDefault(); const title = document.getElementById('evtTitle').value.trim(), category = document.getElementById('evtCategory').value || null, desc = document.getElementById('evtDesc').value.trim() || null, date = dateEl.value, time = timeEl.value, rtime = remindEl.value; if (!title || !date || !time) { alert('è«‹å¡«å¯«æ¨™é¡Œ/æ—¥æœŸ/æ™‚é–“'); return } const startIso = `${date}T${time}:00+08:00`, remindIso = rtime ? `${date}T${rtime}:00+08:00` : startIso; try { await window.aiCompanion.fetchJson('/events', { method:'POST', body: JSON.stringify({ title, category, description: desc, start_time: startIso, reminder_time: remindIso }) }); form.reset(); form.style.display='none'; await renderToday(); await loadAndScheduleToday() } catch { alert('æ–°å¢å¤±æ•—ï¼Œç¨å¾Œå†è©¦') } }) }
      renderToday(); loadAndScheduleToday(); bindAddForm()
    })()
  </script>
</body>
</html>
