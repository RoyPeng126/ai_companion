<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智護生活：AI 伴你</title>
  <link rel="icon" href="assets/image/logo.jpg" type="image/x-icon">
  <!-- CSS -->
  <link rel="stylesheet" href="assets/css/style.css">
  <script>
    // 首訪導到 welcome
    (function () {
      const storageKey = 'ai-companion-skip-welcome'
      const fromWelcome = document.referrer && document.referrer.includes('welcome.html')
      try {
        if (!fromWelcome && !sessionStorage.getItem(storageKey)) {
          sessionStorage.setItem(storageKey, 'true')
          window.location.replace('welcome.html')
        }
      } catch (error) {
        if (!fromWelcome) window.location.replace('welcome.html')
      }
    })()
  </script>
</head>
<body>
  <div class="app-shell">
    <header class="top-bar" aria-label="主要導覽">
      <div class="brand">
        <span class="brand-logo" aria-hidden="true">
        <img src="assets/image/logo.jpg" alt="AI Logo" class="logo-img">
        </span>
        <h1>智護生活：AI 伴你</h1>
      </div>
      <button class="menu-toggle" type="button" aria-controls="site-nav" aria-expanded="false" data-menu-toggle>
        <span class="sr-only">切換導覽選單</span>
        <span class="hamburger" aria-hidden="true"></span>
      </button>
      <nav id="site-nav" class="nav-links" data-menu>
        <a href="index.html" aria-current="page">首頁</a>
        <a href="function.html">功能總覽</a>
        <a href="ranking.html">健康排行榜</a>
        <a href="guide.html">離線幫助指南</a>
      </nav>
      <div class="user-menu" id="userMenu" aria-label="使用者選單">
        <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false" title="使用者選單">
          <span class="sr-only">開啟使用者選單</span>
          <span class="avatar-frame">
            <img class="avatar-image" id="avatarImage" alt="使用者頭像" hidden>
            <span class="avatar-initials" id="avatarInitials">U</span>
          </span>
        </button>
        <div class="menu-dropdown" id="userDropdown" hidden>
          <div class="user-header">
            <div class="user-name" id="umName">使用者</div>
            <div class="user-email" id="umEmail"></div>
          </div>
          <!-- 保留隱藏佔位，讓權限行仍能掛載 -->
          <span id="umAccount" hidden aria-hidden="true"></span>
          <button class="menu-item" id="umLogout" type="button">登出</button>
        </div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div>
          <p class="status-pill">家族暖心回饋</p>
          <h2>陪伴聊天，一開機就能用</h2>
      </section>

      <section class="grid two" aria-label="家族暖心回饋">
        <article class="card">
          <h3>家族暖心回饋</h3>
          <div class="chat-window" data-ai-chat>
            <div class="voice-selection">
              <div class="chat-preferences">
                <div class="chat-preferences__row">
                  <label for="persona-selector">陪聊角色</label>
                  <select id="persona-selector" name="persona-selector">
                    <option value="child">活力童年版</option>
                    <option value="adult">溫柔青壯版</option>
                    <option value="senior">智慧長者版</option>
                  </select>
                </div>
                <p id="chat-persona" class="helper-text">目前陪聊夥伴：智慧長者版</p>
                <div class="chat-preferences__row chat-preferences__row--language">
                  <span class="chat-preferences__label">語音語言</span>
                  <div class="language-toggle" data-language-options role="group" aria-label="語音語言選擇">
                    <button type="button" class="language-chip is-selected" data-language-option="zh-TW" aria-pressed="true">國語</button>
                    <button type="button" class="language-chip" data-language-option="nan-TW" aria-pressed="false">台語</button>
                  </div>
                </div>
              </div>
            <div class="chat-log" id="chat-log" aria-live="polite"></div>
            <div id="chat-status" class="chat-status helper-text" role="status" aria-live="assertive"></div>
            <div class="voice-memos" aria-label="語音備忘錄">
              <div class="voice-memos-header">
                <h4>語音備忘錄</h4>
                <button id="clear-memos" class="link-button" type="button">清除</button>
              </div>
              <ul id="memo-list" class="memo-list"></ul>
            </div>
            <div class="chat-input">
              <label class="sr-only" for="chat-message">輸入訊息</label>
              <textarea id="chat-message" aria-label="輸入訊息" placeholder="說說今天想聊的事..." rows="2"></textarea>
              <div class="chat-actions">
                <button class="btn icon-only voice-button" type="button" id="record-toggle" aria-label="開始錄音">
                  <svg class="icon" viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 15.5a3.5 3.5 0 0 0 3.5-3.5V6a3.5 3.5 0 0 0-7 0v6a3.5 3.5 0 0 0 3.5 3.5Zm5-3.5a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V22h2v-3.08A7 7 0 0 0 19 12h-2Z"/></svg>
                  <span class="sr-only" data-record-label>開始錄音</span>
                </button>
                <button class="btn primary send-button" type="button" id="send-text">
                  <svg class="icon" viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false"><path fill="currentColor" d="m17.27 10.74-8.02-4.67a1 1 0 0 0-1.49.86v9.14a1 1 0 0 0 1.5.86l8.02-4.47a1 1 0 0 0-.01-1.72Zm-7.51 3.61V9.66L14.78 12l-5.02 2.35Z"/></svg>
                  <span>傳送</span>
                </button>
              </div>
            </div>
            <p class="helper-text">按下「開始錄音」說出想提醒的事，系統可轉成備忘錄，並由 AI 夥伴語音回覆。</p>

            <div class="interest-panel" id="interest-card" aria-labelledby="interest-card-title">
              <h4 id="interest-card-title">興趣話題收藏</h4>
              <p class="helper-text">直接在此頁語音或輸入長者喜歡的主題，AI 夥伴會把它當作聊天風格參考。</p>
              <div class="interest-meta">
                <p>目前設定長者：<strong id="interest-elder-name">載入中...</strong></p>
              </div>
              <div class="interest-inputs">
                <label for="interestText">有興趣的話題</label>
                <textarea id="interestText" rows="2" placeholder="例如：懷舊歌曲、園藝、孫子趣事"></textarea>
                <div class="interest-actions">
                  <button class="btn secondary" type="button" id="interest-record-btn">語音輸入</button>
                  <button class="btn primary" type="button" id="interest-save-btn">儲存興趣</button>
                </div>
                <p class="helper-text" id="interestStatus">可按下「語音輸入」說出想聊的話題，系統會自動轉成文字並儲存。</p>
              </div>
              <div class="interest-list">
                <h5>已收藏的興趣</h5>
                <ul id="interestList" aria-live="polite"></ul>
              </div>
              <div class="interest-history">
                <div class="interest-history__header">
                  <h5>歷史聊天記錄</h5>
                  <button class="btn secondary btn-sm interest-history__toggle" type="button" id="interestHistoryToggle" aria-expanded="false">展開</button>
                </div>
                <ul id="interestChatHistory" aria-live="polite" hidden></ul>
              </div>
            </div>
          </div>
        </article>
      </section>

    </main>

    <footer>
      <p>© 2025 NCCU=MIS+STAT．以科技帶來有溫度的陪伴</p>
    </footer>
  </div>
 
  <!-- JS：首頁精簡版（僅聊天） -->
  <script src="assets/js/app.js"></script>
  <script src="assets/js/toast.js"></script>
  <script src="assets/js/chat.js"></script>
  <script src="assets/js/companion-style.js"></script>
  <script src="assets/js/reminder-policies.js"></script>
  
  <!-- 授權守門與使用者選單 -->
  <script src="assets/js/config.js"></script>
  <script>
    (async function guardAuth() {
      const API_BASE = (window.aiCompanion?.getApiBase?.() || 'http://localhost:3001').replace(/\/$/, '')
      try {
        const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' })
        if (!res.ok) {
          if (res.status === 401) {
            try { window.aiCompanion?.clearAuthToken?.() } catch (_) {}
          }
          location.href = 'login.html?error=login_required'
        }
      } catch {
        location.href = 'login.html?error=login_required'
      }
    })()
  </script>
  <script>
    (function initUserMenu(){
      const API_BASE = (window.aiCompanion?.getApiBase?.() || 'http://localhost:3001').replace(/\/$/, '')
      const btn = document.getElementById('avatarBtn'), dd = document.getElementById('userDropdown'), initialsEl = document.getElementById('avatarInitials'), avatarImg = document.getElementById('avatarImage'), nameEl = document.getElementById('umName'), emailEl = document.getElementById('umEmail'), logoutBtn = document.getElementById('umLogout')
      function toInitials(name){ if(!name) return 'U'; const parts=String(name).trim().split(/\s+/); return parts.length===1?parts[0].slice(0,2).toUpperCase():(parts[0][0]+parts[1][0]).toUpperCase() }
      let announced = false
      function announceUser(user){
        if (!user || announced) return
        announced = true
        if (window.aiCompanion) {
          window.aiCompanion.currentUser = user
        }
        try {
          window.dispatchEvent(new CustomEvent('ai-companion:user-ready', { detail: user }))
        } catch (_) {}
      }
      async function loadUser(){
        try {
          const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' })
          if(!res.ok) return
          const json = await res.json()
          const user = json.user || {}
          const display = user.full_name || user.username || user.email || '使用者'
          const avatarUrl = user.avatar_url || user.avatar
          if(nameEl) nameEl.textContent = display
          if(emailEl) emailEl.textContent = user.email || ''
          if(initialsEl) initialsEl.textContent = toInitials(display)
          if(avatarImg){
            if(avatarUrl){
              avatarImg.src=avatarUrl
              avatarImg.alt=`${display} 的頭像`
              avatarImg.hidden=false
              if(initialsEl) initialsEl.hidden=true
            } else {
              avatarImg.removeAttribute('src')
              avatarImg.hidden=true
              if(initialsEl) initialsEl.hidden=false
            }
          }
          announceUser(user)
        } catch {}
      }
      function openMenu(){ dd.hidden=false; btn.setAttribute('aria-expanded','true'); document.addEventListener('click', onDocClick); document.addEventListener('keydown', onEsc) }
      function closeMenu(){ dd.hidden=true; btn.setAttribute('aria-expanded','false'); document.removeEventListener('click', onDocClick); document.removeEventListener('keydown', onEsc) }
      function onDocClick(e){ if(!dd.contains(e.target) && !btn.contains(e.target)) closeMenu() }
      function onEsc(e){ if(e.key==='Escape') closeMenu() }
      if (btn) btn.addEventListener('click', (e)=>{ e.stopPropagation(); dd.hidden ? openMenu() : closeMenu() })
      if (logoutBtn) logoutBtn.addEventListener('click', async ()=>{
        try { await fetch(`${API_BASE}/api/auth/logout`, { method:'POST', credentials:'include' }) } catch {}
        try { window.aiCompanion?.clearAuthToken?.() } catch (_) {}
        location.href='login.html?error=login_required'
      })
      loadUser()
    })()
  </script>
</body>
</html>
