<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºè­·ç”Ÿæ´»ï¼šAI ä¼´ä½ </title>
  <link rel="icon" href="assets/image/logo.jpg" type="image/x-icon">
  <!-- CSS -->
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <link rel="stylesheet" href="assets/css/safety-map.css">
  <script>
    // é¦–è¨ªå°åˆ° welcome
    (function () {
      const storageKey = 'ai-companion-skip-welcome'
      const fromWelcome = document.referrer && document.referrer.includes('welcome.html')
      try {
        if (!fromWelcome && !sessionStorage.getItem(storageKey)) {
          sessionStorage.setItem(storageKey, 'true')
          window.location.replace('welcome.html')
        }
      } catch (error) {
        if (!fromWelcome) window.location.replace('welcome.html')
      }
    })()
  </script>
</head>
<body>
  <div class="app-shell">
    <header class="top-bar" aria-label="ä¸»è¦å°è¦½">
      <div class="brand">
        <span class="brand-logo" aria-hidden="true">
        <img src="assets/image/logo.jpg" alt="AI Logo" class="logo-img">
        </span>
        <h1>æ™ºè­·ç”Ÿæ´»ï¼šAI ä¼´ä½ </h1>
      </div>
      <button class="menu-toggle" type="button" aria-controls="site-nav" aria-expanded="false" data-menu-toggle>
        <span class="sr-only">åˆ‡æ›å°è¦½é¸å–®</span>
        <span class="hamburger" aria-hidden="true"></span>
      </button>
      <nav id="site-nav" class="nav-links" data-menu>
        <a href="index.html">é¦–é </a>
        <a href="function.html" aria-current="page">åŠŸèƒ½ç¸½è¦½</a>
        <a href="ranking.html">å¥åº·æ’è¡Œæ¦œ</a>
        <a href="guide.html">é›¢ç·šå¹«åŠ©æŒ‡å—</a>
      </nav>
      <div class="user-menu" id="userMenu" aria-label="ä½¿ç”¨è€…é¸å–®">
        <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false" title="ä½¿ç”¨è€…é¸å–®">
          <span class="sr-only">é–‹å•Ÿä½¿ç”¨è€…é¸å–®</span>
          <span class="avatar-frame">
            <img class="avatar-image" id="avatarImage" alt="ä½¿ç”¨è€…é ­åƒ" hidden>
            <span class="avatar-initials" id="avatarInitials">U</span>
          </span>
        </button>
        <div class="menu-dropdown" id="userDropdown" hidden>
          <div class="user-header">
            <div class="user-name" id="umName">ä½¿ç”¨è€…</div>
            <div class="user-email" id="umEmail"></div>
          </div>
          <!-- ä¿ç•™éš±è—ä½”ä½ï¼Œè®“æ¬Šé™è¡Œä»èƒ½æ›è¼‰ -->
          <span id="umAccount" hidden aria-hidden="true"></span>
          <button class="menu-item" id="umLogout" type="button">ç™»å‡º</button>
        </div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div>
          <p class="status-pill">é«˜é½¡å‹å–„ï¼æƒ…æ„Ÿé™ªä¼´ï¼å®‰å…¨å®ˆè­·</p>
          <h2>è®“é™ªä¼´èˆ‡æé†’æˆç‚ºç”Ÿæ´»ä¸€éƒ¨åˆ†</h2>
        </div>
      </section>

      <section class="grid two" aria-label="å¿«é€Ÿæ“ä½œ">
        <article class="card">
          <h3>é‡é»æé†’</h3>
          <div class="reminder-actions">
            <button class="btn secondary" type="button" id="addEventBtn">æ–°å¢æé†’</button>
          </div>
          <form id="addEventForm" style="display:none; margin-top:12px;" class="reminder-form">
            <div class="form-row">
              <label for="evtTitle">æ¨™é¡Œ</label>
              <input type="text" id="evtTitle" name="title" required>
            </div>
            <div class="form-row">
              <label for="evtCategory">åˆ†é¡ï¼ˆå¯é¸ï¼‰</label>
              <input type="text" id="evtCategory" name="category" placeholder="ç”¨è—¥ / å›è¨º / ç”Ÿæ´»">
            </div>
            <div class="form-row">
              <label for="evtDesc">æè¿°ï¼ˆå¯é¸ï¼‰</label>
              <textarea id="evtDesc" name="description" rows="2" placeholder="å¯å¡«å¯«å‚™è¨»ã€åœ°å€æˆ–è¯çµ¡äºº"></textarea>
            </div>
            <div class="form-row grid two">
              <div>
                <label for="evtDate">æ—¥æœŸ</label>
                <input type="date" id="evtDate" name="date" required>
              </div>
              <div>
                <label for="evtTime">æ™‚é–“</label>
                <input type="time" id="evtTime" name="time" required>
              </div>
            </div>
            <div class="form-row">
              <label for="evtRemind">æé†’æ™‚é–“ï¼ˆå¯é¸ï¼Œé è¨­åŒé–‹å§‹æ™‚é–“ï¼‰</label>
              <input type="time" id="evtRemind" name="remind">
            </div>
            <div class="form-actions">
              <button class="btn secondary" type="button" id="cancelAdd">å–æ¶ˆ</button>
              <button class="btn primary" type="submit">å„²å­˜</button>
            </div>
          </form>
          <ul class="list" id="today-list"></ul>
          <p class="helper-text">æé†’ä¾†æºå¯ç”±é•·è€…èªéŸ³æ–°å¢æˆ–å®¶å±¬é ç«¯åŒæ­¥ã€‚</p>
        </article>

        <article class="card" id="safety-card">
          <h3>å®‰å…¨æ¦‚æ³</h3>
          <div class="safety-status" id="safetyStatus">
            <span class="status-chip status-chip--alert" id="safetyChip">å°šæœªè¨­å®š</span>
            <p class="safety-status__summary" id="safetySummary">å°šæœªè¨­å®šä½å®¶åœ°å€ã€‚</p>
            <p class="info-text" id="safetyDetail">è«‹å‰å¾€å¿«é€Ÿè¨­å®šé é¢å„²å­˜ä½å®¶ä½ç½®ï¼Œä»¥å•Ÿç”¨å®‰å…¨ç¯„åœæé†’ã€‚</p>
            <p class="map-feedback map-feedback--error" id="safetyWarning" hidden></p>
          </div>
          <div id="safety-map" aria-label="å®‰å…¨åœ°åœ–"></div>
          <p class="helper-text">å¤–å‡ºæ™‚æœƒåµæ¸¬èˆ‡ä½å®¶çš„è·é›¢ï¼Œè¶…é 2 å…¬é‡Œå°‡é€šçŸ¥å®¶å±¬ã€‚</p>
        </article>
      </section>

      <section class="grid two" aria-label="ç¤¾äº¤èˆ‡å›æ†¶">
        <article class="card friend-forum-card" data-friend-forum aria-live="polite">
          <div class="card-header">
            <div>
              <p class="status-pill">å¥½å‹é™å®š</p>
              <h3>ç¤¾ç¾¤è«–å£‡æ´»å‹•</h3>
              <p class="helper-text">äº’ç›¸æˆç‚ºå¥½å‹å¾Œï¼Œæ‰èƒ½çœ‹åˆ°æ´»å‹•ä¸¦å›è¦†æ˜¯å¦åƒåŠ ã€‚</p>
            </div>
            <button class="btn secondary" type="button" data-friend-refresh>é‡æ–°æ•´ç†</button>
          </div>
          <div class="friend-forum__meta" data-friend-meta>
            <p>æˆ‘çš„ User IDï¼š<strong data-user-id>è¼‰å…¥ä¸­</strong></p>
            <p>è¨»å†Šæ‰‹æ©Ÿï¼š<span data-user-phone>è¼‰å…¥ä¸­</span></p>
          </div>
          <div class="friend-forum__body" data-friend-forum-body>
            <section class="friend-requests">
              <div class="friend-requests__header">
                <h4>å¥½å‹é‚€è«‹</h4>
                <span class="badge" data-request-count>0</span>
              </div>
              <div class="friend-requests__lists">
                <div>
                  <h5>æ”¶åˆ°çš„é‚€è«‹</h5>
                  <ul class="list" data-friend-incoming></ul>
                </div>
                <div>
                  <h5>æˆ‘é€å‡ºçš„é‚€è«‹</h5>
                  <ul class="list" data-friend-sent></ul>
                </div>
              </div>
              <form class="friend-form" data-friend-request-form>
                <label for="friendPhone">è¼¸å…¥å¥½å‹æ‰‹æ©Ÿè™Ÿç¢¼</label>
                <input type="tel" id="friendPhone" name="phone" inputmode="numeric" placeholder="09xxxxxxxx" required>
                <button class="btn primary" type="submit">é€å‡ºé‚€è«‹</button>
                <p class="helper-text">æ¯ä½é•·è¼©æœ€å¤šå¯åŠ å…¥ 10 ä½å¥½å‹ã€‚</p>
              </form>
            </section>

            <section class="friend-list-section">
              <div class="friend-list__header">
                <h4>å¥½å‹åå–®</h4>
                <span class="helper-text" data-friend-count></span>
              </div>
              <ul class="pill-list" data-friend-list></ul>
            </section>

            <section class="friend-events">
              <h4>å¥½å‹è«–å£‡æ´»å‹•</h4>
              <ul class="list" data-friend-events></ul>
              <form class="friend-form" data-friend-event-form>
                <label for="friendEventTitle">æ´»å‹•åç¨±</label>
                <input type="text" id="friendEventTitle" name="title" placeholder="ä¾‹å¦‚ï¼šé€±ä¸‰æ™¨èµ°" required>

                <label for="friendEventTime">æ™‚é–“</label>
                <input type="datetime-local" id="friendEventTime" name="start_time" required>

                <label for="friendEventLocation">åœ°é»</label>
                <input type="text" id="friendEventLocation" name="location" placeholder="é›†åˆä½ç½®ï¼ˆå¯é¸ï¼‰">

                <label for="friendEventParticipants">æƒ³é‚€è«‹çš„å¥½å‹ User IDï¼ˆå¯ç•™ç™½ï¼‰</label>
                <input type="text" id="friendEventParticipants" name="participant_user_ids" placeholder="101, 205">
                <button class="btn secondary" type="submit">ç™¼å¸ƒæ´»å‹•</button>
              </form>
            </section>
          </div>
          <div class="friend-forum__empty" data-friend-forum-empty hidden>
            <p>æ­¤å€å¡Šåƒ…æä¾›é•·è¼©å¸³è™Ÿä½¿ç”¨ã€‚è«‹å”åŠ©é•·è¼©åˆ†äº«æ‰‹æ©Ÿèˆ‡ User IDï¼Œè®“å¥½å‹å¯ä»¥åŠ å…¥ã€‚</p>
          </div>
        </article>
        <article class="card facebook-feed-card" data-facebook-feed>
          <div class="card-header">
            <h3>è¦ªå‹æœ€æ–°å‹•æ…‹</h3>
            <button class="btn secondary" type="button" data-facebook-refresh aria-label="é‡æ–°æ•´ç† Facebook è²¼æ–‡">é‡æ–°æ•´ç†</button>
          </div>
          <ul class="list facebook-feed__list" id="facebook-feed-list">
            <li class="facebook-feed__empty"><span>è²¼æ–‡è¼‰å…¥ä¸­...</span></li>
          </ul>
          <p class="helper-text" id="facebook-feed-status">åƒ…é¡¯ç¤ºä¸»å‹•æˆæ¬Šçš„å®¶äººã€ç²‰çµ²å°ˆé èˆ‡æ‰‹å‹•åˆ†äº«å…§å®¹ï¼Œå®‰å…¨åˆåˆè¦ã€‚</p>
        </article>
      </section>

    </main>

    <footer>
      <p>Â© 2025 NCCU=MIS+STATï¼ä»¥ç§‘æŠ€å¸¶ä¾†æœ‰æº«åº¦çš„é™ªä¼´</p>
    </footer>
  </div>

  <!-- JS é †åºï¼šå…ˆåŸºç¤ï¼Œå†åŠŸèƒ½æ¨¡çµ„ -->
  <script>
    // Reorder cards: Chat -> top-left, Today -> top-right, Safety map -> next row left
    (function(){
      try {
        const grids = document.querySelectorAll('.grid.two');
        if (grids.length >= 2) {
          const first = grids[0];
          const second = grids[1];
          const todayCard = first.querySelector('#today-list')?.closest('article');
          const safetyCard = first.querySelector('#safety-card');
          const chatCard = second.querySelector('[data-ai-chat]')?.closest('article');
          const secondArticles = Array.from(second.querySelectorAll('article'));
          const socialCard = secondArticles.find(a => !a.contains(second.querySelector('[data-ai-chat]')));
          if (first && second && todayCard && safetyCard && chatCard && socialCard) {
            first.insertBefore(chatCard, first.firstChild);
            if (todayCard !== first.lastElementChild) first.appendChild(todayCard);
            second.insertBefore(safetyCard, second.firstChild);
            if (socialCard !== second.lastElementChild) second.appendChild(socialCard);
          }
        }
      } catch(_) {}
    })();
  </script>
  <script src="assets/js/app.js"></script>
    <script src="assets/js/toast.js"></script>
    <script src="assets/js/facebook-feed.js"></script>
    <script src="assets/js/friend-forum.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/chat.js"></script>
    <script src="assets/js/companion-style.js"></script>
    <script src="assets/js/reminders.js"></script>
    <script src="assets/js/reminder-policies.js"></script>
    <script src="assets/js/care-elder-invitations.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- å®‰å…¨åœ°åœ–æ¨¡çµ„ -->
  <script type="module">
    import {
      initLeafletMap,
      getStoredHome,
      saveHome,
      haversineDistanceMeters,
      metersToKmString,
      SAFETY_RADIUS_METERS
    } from './assets/js/safety-map.js'
    const chipEl = document.getElementById('safetyChip')
    const summaryEl = document.getElementById('safetySummary')
    const detailEl = document.getElementById('safetyDetail')
    const warningEl = document.getElementById('safetyWarning')
    const { map, L } = initLeafletMap('safety-map', { zoomControl: false })
    const homeIcon = L.divIcon({ className: 'home-marker', html: '<span class="home-marker__icon">ğŸ </span>', iconAnchor: [16, 32], popupAnchor: [0, -28] })
    let safetyCircle = null, homeMarker = null, userMarker = null, hasAlerted = false
    function setChipState (state) {
      chipEl.classList.remove('status-chip--alert', 'status-chip--safe')
      if (state === 'safe') { chipEl.classList.add('status-chip--safe'); chipEl.textContent = 'å®‰å…¨ç¯„åœå…§' }
      else if (state === 'alert') { chipEl.classList.add('status-chip--alert'); chipEl.textContent = 'å®‰å…¨è­¦ç¤º' }
      else { chipEl.classList.add('status-chip--alert'); chipEl.textContent = 'å°šæœªè¨­å®š' }
    }
    function clearWarning () { warningEl.hidden = true; warningEl.textContent = '' }
    function showWarning (m) { warningEl.hidden = false; warningEl.textContent = m }
    function renderNoHomeState () { setChipState('unset'); summaryEl.textContent = 'å°šæœªè¨­å®šä½å®¶åœ°å€ã€‚'; detailEl.textContent = 'è«‹å‰å¾€å¿«é€Ÿè¨­å®šé é¢å„²å­˜ä½å®¶ä½ç½®ï¼Œä»¥å•Ÿç”¨å®‰å…¨ç¯„åœæé†’ã€‚'; clearWarning() }
    function renderPendingLocation () { setChipState('safe'); summaryEl.textContent = 'æ­£åœ¨å–å¾—ç›®å‰ä½ç½®â€¦'; detailEl.textContent = 'å–å¾—å®šä½å¾Œå°‡æ›´æ–°èˆ‡ä½å®¶çš„è·é›¢ã€‚'; clearWarning() }
    function renderSafeState (distance) { setChipState('safe'); summaryEl.textContent = distance <= 30 ? 'æ‚¨ç›®å‰åœ¨å®¶ä¸­ã€‚' : 'æ‚¨ç›®å‰åœ¨å®‰å…¨ç¯„åœå…§ã€‚'; detailEl.textContent = `è·é›¢ä½å®¶ç´„ ${metersToKmString(distance)}ï¼Œå®‰å…¨ç¯„åœç‚º 2 å…¬é‡Œã€‚`; clearWarning() }
    function renderAlertState (distance) { setChipState('alert'); summaryEl.textContent = 'æ‚¨å·²è¶…å‡ºå®‰å…¨ç¯„åœï¼'; detailEl.textContent = `è·é›¢ä½å®¶ç´„ ${metersToKmString(distance)}ï¼Œè«‹å„˜é€Ÿé€šçŸ¥å®¶äººæˆ–è¿”å›å®‰å…¨å€åŸŸã€‚`; if (!hasAlerted) { alert('æ‚¨å·²è¶…å‡º 2 å…¬é‡Œå®‰å…¨ç¯„åœï¼'); hasAlerted = true } clearWarning() }
    function handleGeolocationError () { showWarning('ç„¡æ³•å–å¾—ç›®å‰ä½ç½®ï¼ˆå¯èƒ½å°šæœªæˆæ¬Šå®šä½ï¼‰ã€‚') }
    async function fetchHomeFromServer () {
      try {
        if (!window.aiCompanion?.fetchJson) return null
        const meRes = await window.aiCompanion.fetchJson('users/me', { method: 'GET' })
        const me = meRes?.user || meRes
        const userId = Number(me?.user_id)
        if (!Number.isFinite(userId)) return null
        const locRes = await window.aiCompanion.fetchJson(`elder-locations/${userId}`, { method: 'GET' })
        const loc = locRes?.location || locRes
        if (loc?.address && Number.isFinite(loc.latitude) && Number.isFinite(loc.longitude)) {
          // æŠŠå¾Œç«¯çš„ä½å®¶ä½ç½®åŒæ­¥åˆ°æœ¬æ©Ÿï¼Œè®“é•·è€…ç«¯èƒ½æ„ŸçŸ¥å®¶å±¬è¨­å®šã€‚
          saveHome({ address: loc.address, lat: Number(loc.latitude), lon: Number(loc.longitude) })
          return { address: loc.address, lat: Number(loc.latitude), lon: Number(loc.longitude) }
        }
      } catch (_) {}
      return null
    }

    let home = getStoredHome()
    if (!home) {
      home = await fetchHomeFromServer()
    }
    if (!home) { renderNoHomeState() } else {
      renderPendingLocation()
      if (homeMarker) map.removeLayer(homeMarker); if (safetyCircle) map.removeLayer(safetyCircle)
      homeMarker = L.marker([home.lat, home.lon], { title: 'ä½å®¶ä½ç½®', icon: homeIcon }).addTo(map).bindPopup('ä½å®¶ä½ç½®')
      safetyCircle = L.circle([home.lat, home.lon], { radius: SAFETY_RADIUS_METERS, color: '#f87171', fillColor: '#fca5a5', fillOpacity: 0.15, weight: 2, dashArray: '6 6' }).addTo(map)
      const bounds = safetyCircle.getBounds(); map.fitBounds(bounds, { padding: [28, 28] })
    }
    function renderUserLocation (coords) {
      if (userMarker) { map.removeLayer(userMarker); userMarker = null }
      if (home && safetyCircle) {
        const distance = haversineDistanceMeters(coords, [home.lat, home.lon])
        const bounds = safetyCircle.getBounds().extend(coords); map.fitBounds(bounds, { padding: [28, 28] })
        if (distance <= 30) { if (homeMarker) homeMarker.openPopup(); renderSafeState(distance); return }
        userMarker = L.marker(coords, { title: 'ç›®å‰ä½ç½®' }).addTo(map).bindPopup('ç›®å‰ä½ç½®'); userMarker.openPopup()
        if (distance <= SAFETY_RADIUS_METERS) renderSafeState(distance); else renderAlertState(distance); return
      }
      userMarker = L.marker(coords, { title: 'ç›®å‰ä½ç½®' }).addTo(map).bindPopup('ç›®å‰ä½ç½®'); userMarker.openPopup(); summaryEl.textContent = 'å·²å–å¾—ç›®å‰ä½ç½®ã€‚'; detailEl.textContent = 'è«‹åœ¨å¿«é€Ÿè¨­å®šé é¢å„²å­˜ä½å®¶åœ°å€ï¼Œä»¥å•Ÿç”¨å®‰å…¨æé†’ã€‚'; map.setView(coords, 15)
    }
    if ('geolocation' in navigator) { navigator.geolocation.getCurrentPosition((pos)=>renderUserLocation([pos.coords.latitude, pos.coords.longitude]), ()=>handleGeolocationError(), { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }) } else { showWarning('ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚') }
    if (!home) { map.setView([25.033, 121.5654], 13) }
  </script>

  <!-- æˆæ¬Šå®ˆé–€èˆ‡ä½¿ç”¨è€…é¸å–® -->
  <script src="assets/js/config.js"></script>
  <script>
    (async function guardAuth() {
      const API_BASE = (window.aiCompanion?.getApiBase?.() || 'http://localhost:3001').replace(/\/$/, '')
      try {
        const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' })
        if (!res.ok) {
          if (res.status === 401) {
            try { window.aiCompanion?.clearAuthToken?.() } catch (_) {}
          }
          location.href = 'login.html?error=login_required'
        }
      } catch {
        location.href = 'login.html?error=login_required'
      }
    })()
  </script>
  <script>
    (function initUserMenu(){
      const API_BASE = (window.aiCompanion?.getApiBase?.() || 'http://localhost:3001').replace(/\/$/, '')
      const btn = document.getElementById('avatarBtn'), dd = document.getElementById('userDropdown'), initialsEl = document.getElementById('avatarInitials'), avatarImg = document.getElementById('avatarImage'), nameEl = document.getElementById('umName'), emailEl = document.getElementById('umEmail'), logoutBtn = document.getElementById('umLogout')
      function toInitials(name){ if(!name) return 'U'; const parts=String(name).trim().split(/\s+/); return parts.length===1?parts[0].slice(0,2).toUpperCase():(parts[0][0]+parts[1][0]).toUpperCase() }
      let announced = false
      function announceUser(user){
        if (!user || announced) return
        announced = true
        if (window.aiCompanion) {
          window.aiCompanion.currentUser = user
        }
        try {
          window.dispatchEvent(new CustomEvent('ai-companion:user-ready', { detail: user }))
        } catch (_) {}
      }
      async function loadUser(){
        try {
          const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' })
          if(!res.ok) return
          const json = await res.json()
          const user = json.user || {}
          const display = user.full_name || user.username || user.email || 'ä½¿ç”¨è€…'
          const avatarUrl = user.avatar_url || user.avatar
          if(nameEl) nameEl.textContent = display
          if(emailEl) emailEl.textContent = user.email || ''
          if(initialsEl) initialsEl.textContent = toInitials(display)
          if(avatarImg){
            if(avatarUrl){
              avatarImg.src=avatarUrl
              avatarImg.alt=`${display} çš„é ­åƒ`
              avatarImg.hidden=false
              if(initialsEl) initialsEl.hidden=true
            } else {
              avatarImg.removeAttribute('src')
              avatarImg.hidden=true
              if(initialsEl) initialsEl.hidden=false
            }
          }
          announceUser(user)
        } catch {}
      }
      function openMenu(){ dd.hidden=false; btn.setAttribute('aria-expanded','true'); document.addEventListener('click', onDocClick); document.addEventListener('keydown', onEsc) }
      function closeMenu(){ dd.hidden=true; btn.setAttribute('aria-expanded','false'); document.removeEventListener('click', onDocClick); document.removeEventListener('keydown', onEsc) }
      function onDocClick(e){ if(!dd.contains(e.target) && !btn.contains(e.target)) closeMenu() }
      function onEsc(e){ if(e.key==='Escape') closeMenu() }
      if (btn) btn.addEventListener('click', (e)=>{ e.stopPropagation(); dd.hidden ? openMenu() : closeMenu() })
      if (logoutBtn) logoutBtn.addEventListener('click', async ()=>{
        try { await fetch(`${API_BASE}/api/auth/logout`, { method:'POST', credentials:'include' }) } catch {}
        try { window.aiCompanion?.clearAuthToken?.() } catch (_) {}
        location.href='login.html?error=login_required'
      })
      loadUser()
    })()
  </script>

  <!-- å–®ä¸€ç‰ˆæœ¬ï¼šé‡é»æé†’ï¼ˆæ¸²æŸ“/æ–°å¢/åˆªé™¤/å®Œæˆ/é€šçŸ¥ï¼‰ -->
  <script>
    (function initToday(){
      const TAIPEI_TZ = 'Asia/Taipei'
      const DAY_MS = 24*60*60*1000;
      function todayRangeInTaipei(){ const now = new Date(); const ymd = new Intl.DateTimeFormat('en-CA', { timeZone: TAIPEI_TZ, year:'numeric', month:'2-digit', day:'2-digit' }).format(now); const start = new Date(`${ymd}T00:00:00+08:00`); const end = new Date(start.getTime() + DAY_MS); return { from: start.toISOString(), to: end.toISOString(), ymd } }
      function extendedEventRange(){ const base = todayRangeInTaipei(); const start = new Date(base.from); const extendedFrom = new Date(start.getTime() - DAY_MS); const extendedTo = new Date(start.getTime() + 7 * DAY_MS); return { from: extendedFrom.toISOString(), to: extendedTo.toISOString() } }

      const relativeLabel = (eventDate) => {
        const today = new Date()
        const currentYmd = new Intl.DateTimeFormat('en-CA', { timeZone: TAIPEI_TZ, year: 'numeric', month: '2-digit', day: '2-digit' }).format(today)
        const targetYmd = new Intl.DateTimeFormat('en-CA', { timeZone: TAIPEI_TZ, year: 'numeric', month: '2-digit', day: '2-digit' }).format(eventDate)
        const todayDate = new Date(`${currentYmd}T00:00:00+08:00`)
        const targetDate = new Date(`${targetYmd}T00:00:00+08:00`)
        const diffDays = Math.round((targetDate - todayDate) / (24 * 60 * 60 * 1000))
        if (diffDays === 0) return 'ä»Šå¤©'
        if (diffDays === -1) return 'æ˜¨å¤©'
        if (diffDays === 1) return 'æ˜å¤©'
        return `${targetYmd.slice(5, 7)}æœˆ${targetYmd.slice(8, 10)}æ—¥`
      }

      // Improved renderer: includes location, and provides å®Œæˆ/åˆªé™¤æŒ‰éˆ•
      async function renderTodayV2(){
        const listEl = document.getElementById('today-list');
        if (!listEl) return;
        const range = extendedEventRange();
        const qs = new URLSearchParams({ from: range.from, to: range.to }).toString();
        try {
          const data = await window.aiCompanion.fetchJson(`/events?${qs}`);
          const events = Array.isArray(data?.events) ? data.events : [];
          if (!events.length) { listEl.innerHTML = '<li><span>ä»Šå¤©å°šç„¡æé†’</span></li>'; return }
          listEl.innerHTML = '';
          for (const ev of events) {
            const li = document.createElement('li');
            const t = new Date(ev.start_time);
            const hh = String(t.getHours()).padStart(2,'0');
            const mm = String(t.getMinutes()).padStart(2,'0');
            const time = `${hh}:${mm}`;
            const dayLabel = relativeLabel(t);
            const loc = ev.location ? ` ï¼  ${String(ev.location)}` : '';
            li.innerHTML = `<strong>${dayLabel} ${time}</strong><span>${(ev.title||'').toString()}${loc}</span><span style="margin-left:auto"></span><button class="btn secondary" data-done>å®Œæˆ</button><button class="btn secondary" data-del>åˆªé™¤</button>`;
            li.title = ev.description || '';
            li.style.cursor='pointer';
            li.addEventListener('click', async ()=>{ try { await window.aiCompanion.fetchJson(`/events/${ev.id}`, { method:'PATCH', body: JSON.stringify({ status: !ev.status }) }); ev.status=!ev.status; li.style.opacity = ev.status ? '0.55' : '1' } catch {} });
            li.querySelector('[data-done]').addEventListener('click', async (e)=>{ e.stopPropagation(); try { await window.aiCompanion.fetchJson(`/events/${ev.id}`, { method:'PATCH', body: JSON.stringify({ status: true }) }); li.remove() } catch { alert('æ¨™è¨˜å®Œæˆå¤±æ•—ï¼Œç¨å¾Œå†è©¦') } });
            li.querySelector('[data-del]').addEventListener('click', async (e)=>{ e.stopPropagation(); if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æé†’ï¼Ÿ')) return; try { await window.aiCompanion.fetchJson(`/events/${ev.id}`, { method:'DELETE' }); li.remove() } catch { alert('åˆªé™¤å¤±æ•—ï¼Œç¨å¾Œå†è©¦') } });
            if (ev.status) li.style.opacity='0.55';
            listEl.appendChild(li)
          }
        } catch (error) {
          listEl.innerHTML = '<li><span>è¼‰å…¥æé†’å¤±æ•—ï¼Œç¨å¾Œå†è©¦</span></li>';
          console.warn('[today events] load failed', error)
        }
      }
      async function renderToday(){
        const listEl = document.getElementById('today-list');
        if (!listEl) return;
        const range = extendedEventRange();
        const qs = new URLSearchParams({ from: range.from, to: range.to }).toString();
        try {
          const data = await window.aiCompanion.fetchJson(`/events?${qs}`);
          const events = Array.isArray(data?.events) ? data.events : [];
          if (!events.length) { listEl.innerHTML = '<li><span>ä»Šå¤©å°šç„¡æé†’</span></li>'; return }
          listEl.innerHTML = '';
          for (const ev of events) {
            const li = document.createElement('li');
            const t = new Date(ev.start_time);
            const hh = String(t.getHours()).padStart(2,'0');
            const mm = String(t.getMinutes()).padStart(2,'0');
            const time = `${hh}:${mm}`;
            const dayLabel = relativeLabel(t);
            li.innerHTML = `<strong>${dayLabel} ${time}</strong><span>${(ev.title||'').toString()}</span><button class="btn secondary" data-del style="margin-left:auto">åˆªé™¤</button>`;
            li.title = ev.description || '';
            li.style.cursor='pointer';
            li.addEventListener('click', async ()=>{ try { await window.aiCompanion.fetchJson(`/events/${ev.id}`, { method:'PATCH', body: JSON.stringify({ status: !ev.status }) }); ev.status=!ev.status; li.style.opacity = ev.status ? '0.55' : '1' } catch {} });
            li.querySelector('[data-del]').addEventListener('click', async (e)=>{ e.stopPropagation(); if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æé†’ï¼Ÿ')) return; try { await window.aiCompanion.fetchJson(`/events/${ev.id}`, { method:'DELETE' }); li.remove() } catch { alert('åˆªé™¤å¤±æ•—ï¼Œç¨å¾Œå†è©¦') } });
            if (ev.status) li.style.opacity='0.55';
            listEl.appendChild(li)
          }
        } catch (error) {
          listEl.innerHTML = '<li><span>è¼‰å…¥æé†’å¤±æ•—ï¼Œç¨å¾Œå†è©¦</span></li>';
          console.warn('[today events] load failed', error)
        }
      }
      function scheduleNotifications(events){ if (!('Notification' in window)) return; if (Notification.permission !== 'granted') { Notification.requestPermission().catch(()=>{}) } const now = Date.now(); for (const ev of events) { const target = ev.reminder_time || ev.start_time; if (!target) continue; const at = Date.parse(target), delay = at - now; if (Number.isFinite(delay) && delay > 0 && delay <= 24*60*60*1000) { setTimeout(()=>{ try { if (Notification.permission==='granted') new Notification(ev.title || 'æé†’', { body: ev.description || 'æ™‚é–“åˆ°äº†', silent: false }) } catch {} }, delay) } } }
      async function loadAndScheduleToday(){ const range = todayRangeInTaipei(); const qs = new URLSearchParams({ from: range.from, to: range.to }).toString(); try { const data = await window.aiCompanion.fetchJson(`/events?${qs}`); const events = Array.isArray(data?.events) ? data.events : []; scheduleNotifications(events) } catch {} }
      function bindAddForm(){
        const toggleBtn = document.getElementById('addEventBtn')
        const form = document.getElementById('addEventForm')
        if (!toggleBtn || !form) {
          console.warn('[today events] add form not found, skip binding')
          return
        }

        const cancelBtn = document.getElementById('cancelAdd')
        const dateEl = document.getElementById('evtDate')
        const timeEl = document.getElementById('evtTime')
        const remindEl = document.getElementById('evtRemind')

        const range = todayRangeInTaipei()
        if (dateEl) dateEl.value = range.ymd
        if (timeEl) timeEl.value = '09:00'

        toggleBtn.addEventListener('click', () => {
          form.style.display = form.style.display === 'none' ? 'block' : 'none'
        })

        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => {
            form.style.display = 'none'
          })
        }

        form.addEventListener('submit', async (e) => {
          e.preventDefault()
          const title = document.getElementById('evtTitle')?.value.trim()
          const category = document.getElementById('evtCategory')?.value || null
          const desc = document.getElementById('evtDesc')?.value.trim() || null
          const date = dateEl?.value
          const time = timeEl?.value
          const rtime = remindEl?.value
          if (!title || !date || !time) {
            alert('è«‹å¡«å¯«æ¨™é¡Œ/æ—¥æœŸ/æ™‚é–“')
            return
          }

          const startIso = `${date}T${time}:00+08:00`
          const remindIso = rtime ? `${date}T${rtime}:00+08:00` : startIso

          try {
            await window.aiCompanion.fetchJson('/events', {
              method: 'POST',
              body: JSON.stringify({
                title,
                category,
                description: desc,
                start_time: startIso,
                reminder_time: remindIso
              })
            })
            form.reset()
            form.style.display = 'none'
            await renderTodayV2()
            await loadAndScheduleToday()
          } catch {
            alert('æ–°å¢å¤±æ•—ï¼Œç¨å¾Œå†è©¦')
          }
        })
      }
      renderTodayV2(); loadAndScheduleToday(); bindAddForm()
    })()
  </script>
  <script>
    (function enhanceReminderFilter(){
      const DAY_MS = 24*60*60*1000;
      const TAIPEI_TZ = 'Asia/Taipei';
      document.addEventListener('DOMContentLoaded', () => {
        const listEl = document.getElementById('today-list');
        if (!listEl) return;

        const card = listEl.closest('.card');
        if (!card) return;

        let filterInput = document.getElementById('reminderFilterDate');
        if (!filterInput) {
          const row = document.createElement('div');
          row.className = 'reminder-filter-row';
          const label = document.createElement('label');
          label.htmlFor = 'reminderFilterDate';
          label.textContent = 'æ—¥æœŸ';
          filterInput = document.createElement('input');
          filterInput.type = 'date';
          filterInput.id = 'reminderFilterDate';
          const clearBtn = document.createElement('button');
          clearBtn.type = 'button';
          clearBtn.className = 'reminder-filter-clear';
          clearBtn.textContent = 'æ¸…é™¤æ—¥æœŸï¼ˆå›åˆ°é è¨­ï¼‰';
          row.appendChild(label);
          row.appendChild(filterInput);
          row.appendChild(clearBtn);
          card.insertBefore(row, listEl);
          const helper = card.querySelector('.helper-text');
          if (helper) helper.textContent = 'é¸æ“‡æŸæ—¥æœƒé¡¯ç¤ºè©²æ—¥æé†’ï¼Œæ¸…é™¤æ—¥æœŸå‰‡å›åˆ°ã€Œæ˜¨æ—¥æœªå®Œæˆ + ä»Šæ—¥èˆ‡æ˜æ—¥ã€ã€‚';
          clearBtn.addEventListener('click', () => {
            filterInput.value = '';
            applyFilter();
          });
        }

        const fmt = new Intl.DateTimeFormat('en-CA', {
          timeZone: TAIPEI_TZ,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });

        const computeBaseDates = () => {
          const now = new Date();
          const todayYmd = fmt.format(now);
          const todayDate = new Date(`${todayYmd}T00:00:00+08:00`);
          const yesterdayYmd = fmt.format(new Date(todayDate.getTime() - DAY_MS));
          const tomorrowYmd = fmt.format(new Date(todayDate.getTime() + DAY_MS));
          return { todayYmd, yesterdayYmd, tomorrowYmd };
        };

        const getYmdFromLabel = (label) => {
          if (!label) return null;
          label = label.trim();
          const { todayYmd, yesterdayYmd, tomorrowYmd } = computeBaseDates();
          if (label.startsWith('ä»Šå¤©')) return todayYmd;
          if (label.startsWith('æ˜¨å¤©')) return yesterdayYmd;
          if (label.startsWith('æ˜å¤©')) return tomorrowYmd;
          const m = label.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/);
          if (!m) return null;
          const now = new Date();
          const year = now.getFullYear();
          const mm = String(Number(m[1])).padStart(2, '0');
          const dd = String(Number(m[2])).padStart(2, '0');
          return `${year}-${mm}-${dd}`;
        };

        const applyFilter = () => {
          const { todayYmd, yesterdayYmd, tomorrowYmd } = computeBaseDates();
          const selected = filterInput && filterInput.value ? filterInput.value : null;
          const items = Array.from(listEl.querySelectorAll('li'));
          items.forEach(li => {
            const strong = li.querySelector('strong');
            if (!strong) return;
            const label = strong.textContent || '';
            const ymd = getYmdFromLabel(label);
            if (!ymd) {
              li.style.display = 'none';
              return;
            }
            let show = false;
            if (selected) {
              show = (ymd === selected);
            } else {
              const completed = (li.style.opacity === '0.55');
              if (ymd === todayYmd || ymd === tomorrowYmd) show = true;
              else if (ymd === yesterdayYmd && !completed) show = true;
            }
            li.style.display = show ? '' : 'none';
          });
        };

        applyFilter();

        if (filterInput) {
          filterInput.addEventListener('change', () => {
            applyFilter();
          });
        }

        try {
          const obs = new MutationObserver(() => {
            applyFilter();
          });
          obs.observe(listEl, { childList: true, subtree: false, attributes: true, attributeFilter: ['style'] });
        } catch (_) {}
      });
    })();
  </script>
</body>
</html>
