<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>離線幫助指南｜智護生活</title>
  <link rel="icon" href="assets/image/logo.jpg" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .guide-section {
      display: grid;
      gap: 1.25rem;
    }
    .guide-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="top-bar" aria-label="主要導覽">
      <div class="brand">
        <span class="brand-logo" aria-hidden="true">
        <img src="assets/image/logo.jpg" alt="AI Logo" class="logo-img">
        </span>
        <h1>智護生活：AI 伴你</h1>
      </div>
      <button class="menu-toggle" type="button" aria-controls="site-nav" aria-expanded="false" data-menu-toggle>
        <span class="sr-only">切換導覽選單</span>
        <span class="hamburger" aria-hidden="true"></span>
      </button>
      <nav id="site-nav" class="nav-links" data-menu>
        <a href="index.html">首頁</a>
        <a href="function.html">功能總覽</a>
        <a href="ranking.html">健康排行榜</a>
        <a href="guide.html" aria-current="page">離線幫助指南</a>
      </nav>
      <div class="user-menu" id="userMenu" aria-label="使用者選單">
        <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false" title="使用者選單">
          <span class="sr-only">開啟使用者選單</span>
          <span class="avatar-frame">
            <img class="avatar-image" id="avatarImage" alt="使用者頭像" hidden>
            <span class="avatar-initials" id="avatarInitials">U</span>
          </span>
        </button>
        <div class="menu-dropdown" id="userDropdown" hidden>
          <div class="user-header">
            <div class="user-name" id="umName">使用者</div>
            <div class="user-email" id="umEmail"></div>
          </div>
          <span id="umAccount" hidden aria-hidden="true"></span>
          <button class="menu-item" id="umLogout" type="button">登出</button>
        </div>
      </div>
    </header>

    <main>
      <section class="hero" aria-label="離線指南介紹">
        <div>
          <p class="status-pill">離線也安心</p>
          <h2>沒訊號也照著做</h2>
          <p>內容已存放在手機，可按朗讀聽指示。</p>
        </div>
      </section>

      <section class="card guide-section" aria-label="離線幫助內容">
        <h2>迷路時這樣做</h2>
        <div class="guide-actions">
          <button class="btn primary" type="button" data-read="深呼吸三次，先讓自己安定。">
            朗讀：保持冷靜
          </button>
          <button class="btn primary" type="button" data-read="想想最後看到的店家或地標。">
            朗讀：回想地點
          </button>
          <button class="btn primary" type="button" data-read="找便利商店或派出所借電話。">
            朗讀：尋找訊號
          </button>
          <button class="btn primary" type="button" data-read="到有人員的場所說明情況，請他們幫忙。">
            朗讀：尋找安全場所
          </button>
        </div>
        <ul class="list">
          <li><strong>保持冷靜</strong><span>深呼吸三次再想下一步。</span></li>
          <li><strong>回想地點</strong><span>記下招牌或顏色特別的建物。</span></li>
          <li><strong>尋找訊號</strong><span>到明亮的店家充電並撥電話。</span></li>
          <li><strong>尋找安全場所</strong><span>和服務人員說明，請他們聯絡家人。</span></li>
        </ul>
      </section>

      <section class="card guide-section" aria-label="求助資訊">
        <h2>緊急聯絡資訊</h2>
        <div class="guide-actions">
          <button class="btn secondary" type="button" data-read="家人阿海電話：零九二一，三四五，六七八。">
            朗讀：家人電話
          </button>
          <button class="btn secondary" type="button" data-read="社區志工服務站電話：零五，二二二，五五五五。">
            朗讀：志工服務站
          </button>
          <button class="btn secondary" type="button" data-read="緊急狀況請撥打一一九或一一零。">
            朗讀：緊急求助
          </button>
        </div>
      </section>

      <section class="card guide-section" aria-label="自我定位提示">
        <h2>記住方向的小技巧</h2>
        <ul class="list">
          <li><strong>記路標</strong><span>看招牌或顯眼顏色，默念三遍。</span></li>
          <li><strong>利用紙筆</strong><span>小卡上寫家裡地址與家人電話。</span></li>
          <li><strong>按下報平安按鈕</strong><span>AI 奶奶會保留最後定位，恢復訊號再通知家人。</span></li>
        </ul>
      </section>
    </main>

    <footer>
      <p>© 2025 NCCU=MIS+STAT</p>
    </footer>
  </div>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/config.js"></script>
  <script>
    (async function guardAuth() {
      const API_BASE = (window.aiCompanion?.getApiBase?.() || 'http://localhost:3001').replace(/\/$/, '')
      try {
        const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' })
        if (!res.ok) {
          if (res.status === 401) {
            try { window.aiCompanion?.clearAuthToken?.() } catch (_) {}
          }
          location.href = 'login.html?error=login_required'
        }
      } catch {
        location.href = 'login.html?error=login_required'
      }
    })()
  </script>
  <script>
    (function initUserMenu(){
      const API_BASE = (window.aiCompanion?.getApiBase?.() || 'http://localhost:3001').replace(/\/$/, '')
      const btn = document.getElementById('avatarBtn'), dd = document.getElementById('userDropdown'), initialsEl = document.getElementById('avatarInitials'), avatarImg = document.getElementById('avatarImage'), nameEl = document.getElementById('umName'), emailEl = document.getElementById('umEmail'), logoutBtn = document.getElementById('umLogout')
      function toInitials(name){ if(!name) return 'U'; const parts=String(name).trim().split(/\s+/); return parts.length===1?parts[0].slice(0,2).toUpperCase():(parts[0][0]+parts[1][0]).toUpperCase() }
      let announced = false
      function announceUser(user){
        if (!user || announced) return
        announced = true
        if (window.aiCompanion) {
          window.aiCompanion.currentUser = user
        }
        try {
          window.dispatchEvent(new CustomEvent('ai-companion:user-ready', { detail: user }))
        } catch (_) {}
      }
      async function loadUser(){
        try {
          const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' })
          if(!res.ok) return
          const json = await res.json()
          const user = json.user || {}
          const display = user.full_name || user.username || user.email || '使用者'
          const avatarUrl = user.avatar_url || user.avatar
          if(nameEl) nameEl.textContent = display
          if(emailEl) emailEl.textContent = user.email || ''
          if(initialsEl) initialsEl.textContent = toInitials(display)
          if(avatarImg){
            if(avatarUrl){
              avatarImg.src=avatarUrl
              avatarImg.alt=`${display} 的頭像`
              avatarImg.hidden=false
              if(initialsEl) initialsEl.hidden=true
            } else {
              avatarImg.removeAttribute('src')
              avatarImg.hidden=true
              if(initialsEl) initialsEl.hidden=false
            }
          }
          announceUser(user)
        } catch {}
      }
      function openMenu(){ dd.hidden=false; btn.setAttribute('aria-expanded','true'); document.addEventListener('click', onDocClick); document.addEventListener('keydown', onEsc) }
      function closeMenu(){ dd.hidden=true; btn.setAttribute('aria-expanded','false'); document.removeEventListener('click', onDocClick); document.removeEventListener('keydown', onEsc) }
      function onDocClick(e){ if(!dd.contains(e.target) && !btn.contains(e.target)) closeMenu() }
      function onEsc(e){ if(e.key==='Escape') closeMenu() }
      if (btn) btn.addEventListener('click', (e)=>{ e.stopPropagation(); dd.hidden ? openMenu() : closeMenu() })
      if (logoutBtn) logoutBtn.addEventListener('click', async ()=>{
        try { await fetch(`${API_BASE}/api/auth/logout`, { method:'POST', credentials:'include' }) } catch {}
        try { window.aiCompanion?.clearAuthToken?.() } catch (_) {}
        location.href='login.html?error=login_required'
      })
      loadUser()
    })()
  </script>
  <script>
    (function() {
      const buttons = document.querySelectorAll('button[data-read]');
      function speak(text) {
        if (!('speechSynthesis' in window)) {
          alert('此裝置不支援語音朗讀，請改以文字閱讀');
          return;
        }
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        speechSynthesis.cancel();
        speechSynthesis.speak(utterance);
      }
      buttons.forEach(btn => {
        btn.addEventListener('click', () => speak(btn.getAttribute('data-read')));
      });
    })();
  </script>
</body>
</html>
