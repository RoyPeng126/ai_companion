<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>快速設定｜智護生活</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div class="app-shell">
    <header class="top-bar" aria-label="主要導覽">
      <div class="brand">
        <span class="brand-logo" aria-hidden="true">AI</span>
        <h1>智護生活：AI 伴你</h1>
      </div>
      <button class="menu-toggle" type="button" aria-controls="site-nav" aria-expanded="false" data-menu-toggle>
        <span class="sr-only">切換導覽選單</span>
        <span class="hamburger" aria-hidden="true"></span>
      </button>
      <nav id="site-nav" class="nav-links" data-menu>
        <a href="index.html">首頁</a>
        <a href="selection.html">陪伴設定</a>
        <a href="setting.html" aria-current="page">快速設定</a>
        <a href="ranking.html">健康排行榜</a>
        <a href="forum.html">社群公園</a>
        <a href="guide.html">離線幫助指南</a>
      </nav>
    </header>

    <main>
      <section class="hero" aria-label="快速設定引導">
        <div>
          <p class="status-pill">5 分鐘完成基本設定</p>
          <h2>語音提醒、健康任務、緊急聯絡人一次搞定</h2>
          <p>依照情境自動推薦設定項目，長者僅需回答簡單問題即可完成。</p>
        </div>
      </section>

      <section class="card" aria-labelledby="voice-settings-title">
        <h2 id="voice-settings-title">語音合成設定</h2>
        <p class="helper-text">
          選擇 AI 奶奶回覆時使用的語音，所有語音皆由 Yating 提供。
        </p>
        <div class="voice-presets" data-voice-options role="radiogroup" aria-labelledby="voice-settings-title"></div>
        <p class="helper-text">隨時可以在此頁面調整喜歡的聲音風格。</p>
      </section>

      <section class="card" aria-labelledby="setup-form-title">
        <h2 id="setup-form-title">設定向導</h2>
        <form>
          <div>
            <label for="reminder-scenario">提醒情境</label>
            <select id="reminder-scenario" name="reminder-scenario">
              <option>早餐後提醒我吃血壓藥</option>
              <option>每週三提醒繳水費</option>
              <option>週日提醒與家人視訊</option>
            </select>
          </div>

          <div>
            <label for="check-in-time">每日關懷時間</label>
            <input id="check-in-time" name="check-in-time" type="time" value="09:00">
            <p class="helper-text">系統會在此時間詢問心情並同步給家人。</p>
          </div>

          <div>
            <label for="emergency-contact">緊急聯絡人</label>
            <input id="emergency-contact" name="emergency-contact" type="tel" placeholder="請輸入電話，例如：0912-345-678">
          </div>

          <div>
            <label for="safe-zone">安全範圍</label>
            <select id="safe-zone" name="safe-zone">
              <option>住家周邊 1 公里</option>
              <option selected>住家周邊 2 公里</option>
              <option>自訂距離</option>
            </select>
          </div>

          <div>
            <label for="mobility">今日活動目標</label>
            <select id="mobility" name="mobility">
              <option>步行 2000 步</option>
              <option selected>步行 3500 步</option>
              <option>室內伸展 15 分鐘</option>
            </select>
          </div>

          <button class="btn primary" type="submit">儲存設定</button>
        </form>
      </section>
    </main>

    <footer>
      <p>© 2025 NCCU=MIS+STAT</p>
    </footer>
  </div>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/settings.js"></script>
  <script src="assets/js/toast.js"></script>
  <script>
    (function initAccountSettings(){
      const API_BASE = (localStorage.getItem('AI_COMPANION_API_BASE') || 'http://localhost:3001').replace(/\/$/, '')

      async function fetchMe() {
        try {
          const res = await fetch(`${API_BASE}/api/users/me`, { credentials: 'include' })
          if (!res.ok) {
            location.href = 'login.html?error=login_required'
            return null
          }
          const { user } = await res.json()
          return user
        } catch {
          location.href = 'login.html?error=login_required'
          return null
        }
      }

      function ensureForms() {
        // Account profile form (create if missing)
        let profileCard = document.getElementById('account-card')
        if (!profileCard) {
          const main = document.querySelector('main') || document.body
          profileCard = document.createElement('section')
          profileCard.className = 'card'
          profileCard.id = 'account-card'
          profileCard.innerHTML = `
            <h2>帳號資訊</h2>
            <form id="profileForm">
              <div><label>姓名</label><input id="full_name" name="full_name" type="text"></div>
              <div><label>電子郵件</label><input id="email" name="email" type="email"></div>
              <div><label>使用者名稱</label><input id="username" name="username" type="text"></div>
              <div><label>年齡</label><input id="age" name="age" type="number" min="0"></div>
              <div><label>電話</label><input id="phone" name="phone" type="tel"></div>
              <div><label>地址</label><input id="address" name="address" type="text"></div>
              <button class="btn primary" type="submit">儲存</button>
            </form>`
          main.appendChild(profileCard)
        }

        let pwCard = document.getElementById('password-card')
        if (!pwCard) {
          const main = document.querySelector('main') || document.body
          pwCard = document.createElement('section')
          pwCard.className = 'card'
          pwCard.id = 'password-card'
          pwCard.innerHTML = `
            <h2>變更密碼</h2>
            <form id="passwordForm">
              <div><label>目前密碼</label><input id="currentPassword" name="currentPassword" type="password" required></div>
              <div><label>新密碼</label><input id="newPassword" name="newPassword" type="password" required></div>
              <div><label>確認新密碼</label><input id="confirmNewPassword" name="confirmNewPassword" type="password" required></div>
              <button class="btn primary" type="submit">更新密碼</button>
            </form>`
          main.appendChild(pwCard)
        }
      }

      async function bootstrap() {
        ensureForms()
        const user = await fetchMe()
        if (!user) return
        // Fill profile fields
        const byId = (id) => document.getElementById(id)
        if (byId('full_name')) byId('full_name').value = user.full_name || ''
        if (byId('email')) byId('email').value = user.email || ''
        if (byId('username')) byId('username').value = user.username || ''
        if (byId('age')) byId('age').value = user.age ?? ''
        if (byId('phone')) byId('phone').value = user.phone || ''
        if (byId('address')) byId('address').value = user.address || ''

        // Bind submit events
        const profileForm = document.getElementById('profileForm')
        if (profileForm) profileForm.addEventListener('submit', async (e) => {
          e.preventDefault()
          const payload = Object.fromEntries(new FormData(profileForm).entries())
          // Clean empty strings to undefined so PATCH can detect
          Object.keys(payload).forEach(k => { if (payload[k] === '') delete payload[k] })
          try {
            const res = await fetch(`${API_BASE}/api/users/me`, {
              method: 'PATCH', headers: { 'Content-Type': 'application/json' },
              credentials: 'include', body: JSON.stringify(payload)
            })
            if (res.ok) { if (window.showToast) showToast('已更新', { variant: 'success' }); location.reload() }
            else {
              const err = await res.json().catch(()=>({}))
              const msg = err.error === 'email_taken' ? 'Email 已被使用' : err.error === 'username_taken' ? '使用者名稱已被使用' : '更新失敗'
              if (window.showToast) showToast(msg, { variant: 'error' }); else alert(msg)
            }
          } catch { alert('更新失敗') }
        })

        const passwordForm = document.getElementById('passwordForm')
        if (passwordForm) passwordForm.addEventListener('submit', async (e) => {
          e.preventDefault()
          const currentPassword = document.getElementById('currentPassword').value
          const newPassword = document.getElementById('newPassword').value
          const confirm = document.getElementById('confirmNewPassword').value
          if (!newPassword || newPassword.length < 8) { alert('新密碼至少 8 碼'); return }
          if (newPassword !== confirm) { alert('新密碼與確認不一致'); return }
          try {
            const res = await fetch(`${API_BASE}/api/auth/change-password`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              credentials: 'include', body: JSON.stringify({ currentPassword, newPassword })
            })
            if (res.ok) { if (window.showToast) showToast('已更新密碼，請重新登入', { variant: 'success' }); location.href = 'login.html?error=login_required' }
            else {
              const err = await res.json().catch(()=>({}))
              const msg = err.error === 'wrong_password' ? '目前密碼不正確' : '更新失敗'
              if (window.showToast) showToast(msg, { variant: 'error' }); else alert(msg)
            }
          } catch { alert('更新失敗') }
        })
      }

      document.addEventListener('DOMContentLoaded', bootstrap)
    })()
  </script>
</body>
</html>
