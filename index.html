<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智護生活：AI 伴你</title>
  <script>
    (function () {
      const storageKey = 'ai-companion-skip-welcome'
      const fromWelcome = document.referrer && document.referrer.includes('welcome.html')
      try {
        if (!fromWelcome && !sessionStorage.getItem(storageKey)) {
          sessionStorage.setItem(storageKey, 'true')
          window.location.replace('welcome.html')
        }
      } catch (error) {
        if (!fromWelcome) {
          window.location.replace('welcome.html')
        }
      }
    })()
  </script>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div class="app-shell">
    <header class="top-bar" aria-label="主要導覽">
      <div class="brand">
        <span class="brand-logo" aria-hidden="true">AI</span>
        <h1>智護生活：AI 伴你</h1>
      </div>
      <button class="menu-toggle" type="button" aria-controls="site-nav" aria-expanded="false" data-menu-toggle>
        <span class="sr-only">切換導覽選單</span>
        <span class="hamburger" aria-hidden="true"></span>
      </button>
      <nav id="site-nav" class="nav-links" data-menu>
        <a href="index.html" aria-current="page">首頁</a>
        <a href="selection.html">陪伴設定</a>
        <a href="setting.html">快速設定</a>
        <a href="ranking.html">健康排行榜</a>
        <a href="forum.html">社群公園</a>
        <a href="guide.html">離線幫助指南</a>
      </nav>
      <div class="user-menu" id="userMenu" aria-label="使用者選單">
        <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false" title="使用者選單">
          <span class="avatar-initials" id="avatarInitials">U</span>
        </button>
        <div class="menu-dropdown" id="userDropdown" hidden>
          <div class="user-header">
            <div class="user-name" id="umName">使用者</div>
            <div class="user-email" id="umEmail"></div>
          </div>
          <a class="menu-item" href="setting.html" id="umAccount">帳號設定</a>
          <button class="menu-item" id="umLogout" type="button">登出</button>
        </div>
      </div>
    </header>

    <main>
      <!-- Hero 區（只留一句話） -->
      <section class="hero">
        <div>
          <p class="status-pill">高齡友善．情感陪伴．安全守護</p>
          <h2>讓陪伴與提醒成為生活一部分</h2>
          <!-- 原本這裡的段落文字已移除 -->
        </div>
      </section>

      <!-- ✅ 已移除：功能三卡片區塊（id="features"） -->

      <!-- 以下區塊維持不變 -->
      <section class="grid two" aria-label="快速操作">
        <article class="card">
          <h3>今日重點提醒</h3>
          <ul class="list">
            <li><strong>08:30</strong><span>早餐後服用血壓藥</span></li>
            <li><strong>10:00</strong><span>與 AI 奶奶聊聊心情</span></li>
            <li><strong>15:00</strong><span>陪伴散步 20 分鐘</span></li>
          </ul>
          <p class="helper-text">提醒來源可由長者語音新增或家屬遠端同步。</p>
        </article>
        <article class="card">
          <h3>安全概況</h3>
          <p><span class="badge success">安全</span> 阿茲奶奶目前在家中，距離安全圍欄 0.3 公里。</p>
          <p class="helper-text">外出時可設定方圓 2 公里的安全區域，離開會自動通知家人。</p>
        </article>
      </section>

      <section class="grid two" aria-label="社交與回憶">
        <article class="card">
          <h3>家族暖心回饋</h3>
          <div class="chat-window" data-ai-chat>
            <div class="voice-selection">
              <p class="helper-text">選擇 AI 奶奶回覆時的語音風格：</p>
              <div class="voice-presets compact" data-voice-options data-voice-variant="compact" role="radiogroup" aria-label="語音風格選項"></div>
            </div>
            <div class="chat-log" id="chat-log" aria-live="polite"></div>
            <div id="chat-status" class="chat-status helper-text" role="status" aria-live="assertive"></div>
            <div class="voice-memos" aria-label="語音備忘錄">
              <div class="voice-memos-header">
                <h4>語音備忘錄</h4>
                <button id="clear-memos" class="link-button" type="button">清除</button>
              </div>
              <ul id="memo-list" class="memo-list"></ul>
            </div>
            <div class="chat-input">
              <label class="sr-only" for="chat-message">輸入訊息</label>
              <textarea id="chat-message" aria-label="輸入訊息" placeholder="說說今天想聊的事..." rows="2"></textarea>
              <div class="chat-actions">
                <button class="btn icon-only voice-button" type="button" id="record-toggle" aria-label="開始錄音">
                  <svg class="icon" viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M12 15.5a3.5 3.5 0 0 0 3.5-3.5V6a3.5 3.5 0 0 0-7 0v6a3.5 3.5 0 0 0 3.5 3.5Zm5-3.5a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V22h2v-3.08A7 7 0 0 0 19 12h-2Z" />
                  </svg>
                  <span class="sr-only" data-record-label>開始錄音</span>
                </button>
                <button class="btn primary send-button" type="button" id="send-text">
                  <svg class="icon" viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="m17.27 10.74-8.02-4.67a1 1 0 0 0-1.49.86v9.14a1 1 0 0 0 1.5.86l8.02-4.47a1 1 0 0 0-.01-1.72Zm-7.51 3.61V9.66L14.78 12l-5.02 2.35Z"/>
                  </svg>
                  <span>傳送</span>
                </button>
              </div>
            </div>
            <p class="helper-text">按下「開始錄音」說出想提醒的事，系統會自動轉成備忘錄，並由 AI 夥伴語音回覆。</p>
          </div>
        </article>
        <article class="card">
          <h3>社區互動</h3>
          <p>每週五晚上 8 點與家人視訊、每週日分享散步照片，AI 奶奶會貼心提醒並給予鼓勵。</p>
          <p class="helper-text">可設定固定節奏的互動，養成習慣、遠離孤單。</p>
          <a class="btn secondary" href="forum.html">前往社群公園</a>
        </article>
      </section>
    </main>

    <footer>
      <p>© 2025 NCCU=MIS+STAT．以科技帶來有溫度的陪伴</p>
    </footer>
  </div>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/settings.js"></script>
  <script src="assets/js/chat.js"></script>
  <script>
    (async function guardAuth() {
      const API_BASE = (localStorage.getItem('AI_COMPANION_API_BASE') || 'http://localhost:3001').replace(/\/$/, '')
      try {
        const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' })
        if (!res.ok) {
          location.href = 'login.html?error=login_required'
        }
      } catch (e) {
        location.href = 'login.html?error=login_required'
      }
    })()
  </script>
  <script>
    (function initUserMenu(){
      const API_BASE = (localStorage.getItem('AI_COMPANION_API_BASE') || 'http://localhost:3001').replace(/\/$/, '')
      const btn = document.getElementById('avatarBtn')
      const dd = document.getElementById('userDropdown')
      const initialsEl = document.getElementById('avatarInitials')
      const nameEl = document.getElementById('umName')
      const emailEl = document.getElementById('umEmail')
      const logoutBtn = document.getElementById('umLogout')

      function toInitials(name) {
        if (!name) return 'U'
        const parts = String(name).trim().split(/\s+/)
        if (parts.length === 1) return parts[0].slice(0,2).toUpperCase()
        return (parts[0][0] + parts[1][0]).toUpperCase()
      }

      async function loadUser(){
        try {
          const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' })
          if (!res.ok) return
          const json = await res.json()
          const user = json.user || {}
          const display = user.full_name || user.username || user.email || '使用者'
          nameEl.textContent = display
          emailEl.textContent = user.email || ''
          initialsEl.textContent = toInitials(display)
        } catch {}
      }

      function openMenu() {
        dd.hidden = false
        btn.setAttribute('aria-expanded','true')
        document.addEventListener('click', onDocClick)
        document.addEventListener('keydown', onEsc)
      }
      function closeMenu() {
        dd.hidden = true
        btn.setAttribute('aria-expanded','false')
        document.removeEventListener('click', onDocClick)
        document.removeEventListener('keydown', onEsc)
      }
      function onDocClick(e){
        if (!dd.contains(e.target) && !btn.contains(e.target)) closeMenu()
      }
      function onEsc(e){ if (e.key === 'Escape') closeMenu() }

      if (btn) btn.addEventListener('click', (e)=>{
        e.stopPropagation()
        dd.hidden ? openMenu() : closeMenu()
      })

      if (logoutBtn) logoutBtn.addEventListener('click', async ()=>{
        try {
          await fetch(`${API_BASE}/api/auth/logout`, { method:'POST', credentials:'include' })
        } catch {}
        location.href = 'login.html?error=login_required'
      })

      loadUser()
    })()
  </script>
</body>
</html>
